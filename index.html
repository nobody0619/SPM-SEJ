<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ SPM P1 è¶…å¼ºè®­ç»ƒå™¨ / SPM P1 Booster</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --black:#111; --fg:#111; --bg:#fff; --muted:#555;
      --green:#16a34a; --green-2:#22c55e;
      --border:#eee; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    html,body{ background:#fff; }
    body{
      font-family: Arial, sans-serif;
      margin:0; padding:0 12px 40px;
      color:var(--fg); background:var(--bg);
      max-width:1000px; margin-inline:auto;
    }
    body::before{
      content:""; position:fixed; inset:-10% -10% auto -10%;
      height:68vh; pointer-events:none; z-index:-2;
      background:
        radial-gradient(600px 240px at 10% 0%,rgba(34,197,94,.06),rgba(255,255,255,0) 60%),
        radial-gradient(600px 240px at 90% 0%,rgba(56,189,248,.06),rgba(255,255,255,0) 60%);
    }
    h1,h2,h3,h4,h5{ font-weight:700; color:#111; }
    a{ color:#0ea5e9; text-decoration:none; }
    a:hover{ text-decoration:underline; }
    button{
      font-family:inherit; cursor:pointer; border-radius:999px;
      border:0; padding:10px 18px; font-size:14px;
      background:#111; color:#fff;
      box-shadow:var(--shadow);
    }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    .pill{ border-radius:999px; padding:4px 10px; font-size:12px; }
    .muted{ color:var(--muted); font-size:13px; }
    .chip{
      display:inline-flex; align-items:center; gap:4px;
      padding:4px 10px; border-radius:999px;
      background:#f4f4f5; font-size:12px; color:#444;
    }
    .chip b{ font-weight:600; }
    .tag{
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid rgba(15,23,42,.08); font-size:11px;
      color:#475569; background:#f8fafc;
    }
    .card{
      background:#fff; border-radius:18px;
      box-shadow:var(--shadow); padding:18px 16px; margin:10px 0;
      border:1px solid #f4f4f5;
    }
    .card h3{ margin-top:0; margin-bottom:6px; font-size:17px; }
    .card p{ margin:4px 0; font-size:13px; color:#374151; }
    .card ul{ margin:6px 0 4px 18px; padding:0; font-size:13px; color:#374151; }
    .card li{ margin:2px 0; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 10px; border-radius:999px; background:#ecfdf3;
      color:#15803d; font-size:12px;
    }
    .badge span.icon{ font-size:15px; }
    .flex{ display:flex; align-items:center; }
    .flex-between{ display:flex; justify-content:space-between; align-items:center; }
    .flex-wrap{ display:flex; flex-wrap:wrap; align-items:center; gap:6px; }
    .gap-4{ gap:4px; }
    .gap-8{ gap:8px; }
    .gap-10{ gap:10px; }
    .gap-12{ gap:12px; }
    .mt-8{ margin-top:8px; }
    .mt-12{ margin-top:12px; }
    .mt-16{ margin-top:16px; }
    .mt-20{ margin-top:20px; }
    .mb-0{ margin-bottom:0; }
    .mb-4{ margin-bottom:4px; }
    .mb-6{ margin-bottom:6px; }
    .mb-8{ margin-bottom:8px; }
    .mb-12{ margin-bottom:12px; }
    .mb-16{ margin-bottom:16px; }
    .text-sm{ font-size:13px; }
    .text-xs{ font-size:12px; }
    .text-center{ text-align:center; }
    .text-right{ text-align:right; }
    .fw-600{ font-weight:600; }
    .fw-700{ font-weight:700; }
    .highlight{
      background:linear-gradient(120deg,rgba(56,189,248,.2),rgba(34,197,94,.2));
      padding:2px 8px; border-radius:999px; font-size:11px;
    }
    header{
      padding-top:18px;
    }
    #brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    #brand-left{ display:flex; align-items:center; gap:10px; }
    #brand-icon{
      width:36px; height:36px; border-radius:12px;
      background:#111; color:#fff; display:flex; align-items:center; justify-content:center;
      font-size:18px; font-weight:700;
      box-shadow:0 6px 18px rgba(0,0,0,.2);
    }
    #brand-title{
      font-size:17px; font-weight:700; letter-spacing:.02em;
    }
    #brand-sub{
      font-size:12px; color:#6b7280;
    }
    #beta-tag{
      font-size:11px; border-radius:999px;
      padding:2px 8px; border:1px solid rgba(15,23,42,.1);
      color:#475569; background:#f9fafb;
    }

    #menu,#quiz,#finish,#results{ display:none; }

    #topbar{
      position:sticky; top:8px; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin:12px 0;
    }
    .nav-left,.nav-right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .pill-btn{
      border:0; background:#111; color:#fff;
      padding:8px 12px; border-radius:999px;
      cursor:pointer; box-shadow:var(--shadow);
      font-size:13px;
    }
    .pill-btn.light{ background:#222; }
    .pill-btn.primary{ background:#0ea5e9; }
    .pill-btn:disabled{ opacity:.6; cursor:not-allowed; }

    #session-timer{
      background:#111; color:#fff;
      padding:6px 10px; border-radius:999px;
      font-size:11px; opacity:.9; display:none;
      box-shadow:0 4px 10px rgba(0,0,0,.25);
    }
    #sound-toggle.muted{ background:#555; }
    #my-results-btn,#back-to-chapters-btn{ display:none; }

    #wallet-display{
      font-size:12px; color:#111;
      padding:4px 10px; border-radius:999px;
      background:#f4f4f5;
    }

    .hero{
      margin:28px auto; padding:32px 28px;
      border-radius:22px; background:#020617;
      color:#e5e7eb; box-shadow:0 24px 80px rgba(15,23,42,.6);
      position:relative; overflow:hidden;
    }
    .hero::before{
      content:""; position:absolute; inset:-20%;
      background:
        radial-gradient(600px 280px at 10% 0%,rgba(56,189,248,.35),transparent 65%),
        radial-gradient(600px 280px at 90% 10%,rgba(34,197,94,.4),transparent 65%),
        radial-gradient(600px 260px at 50% 110%,rgba(15,23,42,1),rgba(15,23,42,1));
      opacity:.9; z-index:-1;
    }
    .hero-main{
      display:grid; grid-template-columns:minmax(0,1.7fr) minmax(0,1.1fr);
      gap:16px; align-items:center;
    }
    @media(max-width:780px){
      .hero-main{ grid-template-columns:1fr; }
      body{ padding-inline:10px 10px; }
    }
    .hero-title{
      font-size:20px; font-weight:700; margin:0 0 8px;
      letter-spacing:.03em;
    }
    .hero-sub{ font-size:13px; line-height:1.6; color:#d1d5db; margin:0; }
    .hero-sub b{ color:#f97316; }
    .hero-tagline{
      font-size:12px; color:#9ca3af; margin-top:4px;
    }
    .hero-pills{ display:flex; flex-wrap:wrap; gap:6px; margin:10px 0 12px; }
    .hero-pill{
      border-radius:999px; padding:4px 10px; font-size:11px;
      border:1px solid rgba(148,163,184,.5); color:#e5e7eb;
      background:rgba(15,23,42,.4); backdrop-filter:blur(10px);
    }
    .hero-cta-row{
      display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin-top:14px;
    }
    .hero-cta-btn{
      border-radius:999px; padding:9px 16px;
      background:linear-gradient(135deg,#22c55e,#0ea5e9); border:0;
      color:#fff; font-size:13px; font-weight:600;
      box-shadow:0 14px 40px rgba(34,197,94,.55);
    }
    .hero-cta-btn span.icon{ font-size:14px; margin-right:4px; }
    .hero-cta-note{
      font-size:11px; color:#a1a1aa;
    }

    .hero-right{
      position:relative;
      padding:14px 14px 12px;
      border-radius:18px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 60px rgba(15,23,42,.9);
      font-size:12px; color:#e5e7eb;
    }
    .hero-right h3{
      margin:0 0 6px; font-size:13px;
      display:flex; align-items:center; gap:6px;
    }
    .hero-right h3 span.icon{ font-size:16px; }
    .hero-right ul{
      margin:6px 0 4px 18px; padding:0; color:#d1d5db; font-size:12px;
    }
    .hero-right li{ margin:2px 0; }
    .hero-right .chip{
      background:rgba(15,23,42,.84); color:#e5e7eb;
      border:1px solid rgba(148,163,184,.45);
    }
    .hero-tag-badge{
      position:absolute; top:10px; right:12px;
      font-size:11px; padding:3px 8px; border-radius:999px;
      background:rgba(22,163,74,.16); color:#bbf7d0;
      border:1px solid rgba(34,197,94,.5);
    }

    .section-title{
      margin:24px 0 8px;
      font-size:16px; font-weight:700;
    }
    .section-sub{ font-size:13px; color:#6b7280; margin:0 0 10px; }
    .chapter-grid{
      display:grid; grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:720px){
      .chapter-grid{ grid-template-columns:1fr; }
    }
    .chapter-card{
      border-radius:16px; padding:14px 14px 12px;
      background:#fff; border:1px solid #e5e7eb;
      box-shadow:0 8px 24px rgba(15,23,42,.04);
      font-size:13px;
    }
    .chapter-card-header{
      display:flex; justify-content:space-between; align-items:flex-start; gap:8px;
    }
    .chapter-title{ font-size:14px; font-weight:600; margin:0 0 2px; }
    .chapter-meta{ font-size:11px; color:#6b7280; }
    .chapter-progress{
      margin-top:6px; font-size:11px; color:#6b7280;
      display:flex; justify-content:space-between; align-items:center;
    }
    .chapter-progress-bar{
      position:relative; height:6px; border-radius:999px;
      background:#f4f4f5; overflow:hidden; margin-top:4px;
    }
    .chapter-progress-bar-inner{
      position:absolute; inset:0; width:0%;
      background:linear-gradient(90deg,#22c55e,#0ea5e9);
      transition:width .3s ease-out;
    }
    .chapter-tags{ margin-top:6px; display:flex; flex-wrap:wrap; gap:4px; }
    .chapter-bottom{
      margin-top:10px; display:flex; justify-content:space-between; align-items:center;
      font-size:11px; color:#6b7280;
    }
    .chapter-bottom button{
      font-size:12px; padding:7px 12px; border-radius:999px;
      box-shadow:0 6px 18px rgba(15,23,42,.18);
    }

    .rules-box{
      margin:18px 0 8px;
      padding:12px 12px 10px;
      border-radius:16px;
      background:#f9fafb;
      border:1px dashed rgba(148,163,184,.8);
      font-size:12px; color:#374151;
    }
    .rules-box b{ font-weight:600; }
    .rules-box ul{ margin:6px 0 4px 18px; padding:0; }

    #quiz-card{
      margin-top:14px; padding:16px 14px 14px;
      border-radius:18px; background:#fff;
      border:1px solid #e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.06);
    }
    #quiz-meta{
      display:flex; justify-content:space-between; align-items:flex-start;
      font-size:11px; color:#6b7280; margin-bottom:6px;
    }
    #quiz-meta-left{ display:flex; flex-direction:column; gap:4px; }
    #quiz-meta-right{ text-align:right; }
    #quiz-title{ font-size:14px; font-weight:600; color:#111; margin:0; }
    #quiz-stats{ font-size:11px; color:#6b7280; }
    #quiz-question{
      margin:10px 0 8px;
      font-size:14px; line-height:1.5; color:#111;
    }
    #quiz-options{ list-style:none; margin:8px 0 0; padding:0; }
    #quiz-options li{
      background:#f9fafb; border-radius:999px;
      padding:7px 10px; margin:5px 0;
      border:1px solid #e5e7eb;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; font-size:13px;
      cursor:pointer; transition:.18s ease;
    }
    #quiz-options li span.opt-label{
      font-weight:600; font-size:12px; color:#4b5563;
    }
    #quiz-options li span.opt-text{ flex:1; text-align:left; }
    #quiz-options li.correct{
      background:#ecfdf3; border-color:#bbf7d0; color:#166534;
    }
    #quiz-options li.wrong{
      background:#fef2f2; border-color:#fecaca; color:#b91c1c;
    }
    #quiz-options li.disabled{
      opacity:.75; cursor:default;
    }
    #quiz-footer{
      margin-top:10px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color:#4b5563;
    }
    #quiz-footer-left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    #quiz-footer-right{ font-size:11px; color:#6b7280; }

    #score-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 10px; border-radius:999px;
      background:#eef2ff; color:#3730a3; font-size:12px;
    }

    #finish-card{
      margin-top:16px; padding:16px 14px 14px;
      border-radius:18px; background:#fff;
      border:1px solid #e5e7eb;
      box-shadow:0 16px 40px rgba(15,23,42,.06);
      font-size:13px; color:#111;
    }

    #results-table{
      width:100%; border-collapse:collapse; margin-top:12px; font-size:12px;
    }
    #results-table th,#results-table td{
      border-bottom:1px solid #e5e7eb; padding:6px 4px; text-align:left;
    }
    #results-table th{ font-weight:600; font-size:11px; color:#4b5563; }
    #results-table tr:nth-child(even){ background:#f9fafb; }

    #wa-fab{
      position:fixed; right:16px; bottom:18px; z-index:60;
      width:46px; height:46px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      background:#22c55e; color:#fff; font-size:22px;
      box-shadow:0 20px 50px rgba(22,163,74,.5);
    }
    #wa-fab:hover{ transform:translateY(-1px); box-shadow:0 24px 60px rgba(22,163,74,.6); }

    .score-bubble{
      position:absolute; right:18px; top:10px;
      padding:3px 8px; border-radius:999px;
      font-size:11px; font-weight:600;
      animation:popUp .8s ease-out forwards;
      pointer-events:none;
    }
    .score-bubble.plus{
      background:rgba(34,197,94,.15); color:#16a34a;
    }
    .score-bubble.minus{
      background:rgba(239,68,68,.15); color:#dc2626;
    }
    @keyframes popUp{
      0%{transform:translateY(0);opacity:0;}
      15%{opacity:1;}
      100%{transform:translateY(-24px);opacity:0;}
    }

    .progress-wrap{
      width:100%; height:6px; border-radius:999px; background:#f4f4f5;
      overflow:hidden; margin-top:4px;
    }
    .progress-inner{
      height:100%; width:0%; background:linear-gradient(90deg,#22c55e,#0ea5e9);
      transition:width .3s ease-out;
    }

    .label-pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px; background:#eff6ff;
      color:#1d4ed8; font-size:11px;
    }

    #sound-toggle{ min-width:40px; }
    #sound-toggle span{ margin-left:4px; }

  </style>
</head>
<body>
  <header>
    <div id="brand">
      <div id="brand-left">
        <div id="brand-icon">P1</div>
        <div>
          <div id="brand-title">SPM P1 Booster</div>
          <div id="brand-sub">åˆ·é¢˜åˆ°<strong>ä¸ä¼šåšåˆ°ä¼š</strong> Â· From â€œno ideaâ€ to â€œI got thisâ€</div>
        </div>
      </div>
      <div class="flex-wrap gap-8">
        <span id="beta-tag">Beta Â· é«˜å¼ºåº¦æµ‹è¯•ä¸­</span>
      </div>
    </div>
  </header>

  <section id="welcome">
    <div class="hero">
      <div class="hero-main">
        <div class="hero-left">
          <div class="hero-pills">
            <span class="hero-pill">SPM Paper 1 ä¸“ç”¨è®­ç»ƒ Specialised for SPM Paper 1</span>
            <span class="hero-pill">è‡ªåŠ¨é‡å¤é”™é¢˜ Auto-repeat wrong questions</span>
            <span class="hero-pill">æ™ºèƒ½è®¡åˆ† &amp; ç¢ç‰‡å¥–åŠ± Smart scoring &amp; shard rewards</span>
          </div>
          <h1 class="hero-title">åˆ·åˆ°è€ƒåœº<strong>è§æ€ªä¸æ€ª</strong>çš„ P1 è®­ç»ƒå™¨</h1>
          <p class="hero-sub">
            é¢˜ç›®æ¥è‡ªå„å·çœŸé¢˜ã€KVã€MRSM ç­‰å¤šæ¥æºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®°ä½ä½ æ¯ä¸ªç« èŠ‚çš„è¡¨ç°ï¼Œ
            æŠŠâ€œä¸ç†Ÿçš„é¢˜â€ä¸¢å›æ¥ç»™ä½ é‡å¤ç»ƒã€‚<br/>
            æ¯ä¸€é“é¢˜éƒ½æœ‰ <b>åˆ†æ•°å˜åŒ–</b> å’Œ <b>ç¢ç‰‡å¥–åŠ±</b>ï¼Œè®©ä½ åƒæ‰“ game ä¸€æ ·å†²é«˜åˆ†ã€‚
          </p>
          <p class="hero-tagline">
            å…ˆä½“éªŒ 5 åˆ†é’Ÿè¯•ç”¨ï¼Œå†å†³å®šè¦ä¸è¦å¼€é€šæ— é™æ—¶é—´è´¦å·ã€‚
          </p>
          <div class="hero-cta-row">
            <button id="startBtn" class="hero-cta-btn">
              <span class="icon">âš¡</span> å¼€å§‹åˆ·é¢˜ / Start Now
            </button>
            <div class="hero-cta-note">
              æ— éœ€æ³¨å†Œ Â· è¾“å…¥å§“å + å¯†ç å³å¯è¿›å…¥<br/>
              No sign-up needed Â· Just enter your name &amp; password
            </div>
          </div>
        </div>
        <div class="hero-right">
          <span class="hero-tag-badge">è¯•ç”¨ 5 åˆ†é’Ÿ Trial Â· 5 min</span>
          <h3><span class="icon">ğŸ“Š</span> å­¦ç”Ÿç«¯ä¼šçœ‹åˆ°ä»€ä¹ˆï¼ŸWhat will you see?</h3>
          <ul>
            <li><b>ç« èŠ‚è¿›åº¦æ¡</b>ï¼šä¸€çœ¼çœ‹åˆ°æ¯ç« å®Œæˆåº¦ &amp; å‡†ç¡®ç‡</li>
            <li><b>é”™é¢˜è‡ªåŠ¨å›æ”¶ç«™</b>ï¼šç­”é”™çš„é¢˜ä¼šåœ¨åé¢å†å‡ºç° 2 æ¬¡</li>
            <li><b>å®æ—¶åˆ†æ•°æµ®åŠ¨</b>ï¼šæ¯æ¬¡ç­”é¢˜ç«‹åˆ» + åˆ† / - åˆ†</li>
            <li><b>ç¢ç‰‡ &amp; å¤æ´»å¡ç³»ç»Ÿ</b>ï¼šé¼“åŠ±ä½ ç¨³å®šä½œç­”ã€å°‘ä¹±çŒœ</li>
          </ul>
          <div class="mt-8">
            <span class="chip">
              <b>é€‚åˆè°ï¼ŸWho is this for?</b> åŸºç¡€åˆ°ä¸­ä¸Šç¨‹åº¦ F4â€“F5 å­¦ç”Ÿ Â· Students aiming for Aâ€“C
            </span>
          </div>
        </div>
      </div>
    </div>

    <section style="margin-top:20px;">
      <h2 class="section-title">ç™»å½• / Login</h2>
      <p class="section-sub">
        è¯·è¾“å…¥ä½ çš„å§“åå’Œè€å¸ˆç»™çš„å¯†ç ã€‚<br/>
        Enter your name and the password given by your teacher.
      </p>
      <div class="card">
        <div class="flex-wrap gap-10">
          <div style="flex:1 1 220px; min-width:220px;">
            <label class="text-xs">å§“å Name</label><br/>
            <input id="username" type="text" placeholder="ä¾‹å¦‚ï¼šLim Wei Ming" style="width:100%;padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;font-size:13px;"/>
          </div>
          <div style="flex:1 1 200px; min-width:200px;">
            <label class="text-xs">å¯†ç  Password</label><br/>
            <input id="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç  / Enter password" style="width:100%;padding:8px 10px;border-radius:999px;border:1px solid #e5e7eb;font-size:13px;"/>
          </div>
        </div>
        <div class="flex-between mt-12">
          <div class="text-xs" style="color:#6b7280;">
            å¦‚å¯†ç æœ‰é—®é¢˜ï¼Œè¯·è”ç»œè€å¸ˆã€‚<br/>
            If the password doesnâ€™t work, please contact your teacher.
          </div>
          <button id="loginBtn">ç™»å½• / Log in</button>
        </div>
      </div>

      <div class="rules-box">
        <b>ğŸ® è®¡åˆ† &amp; å¤æ´»è§„åˆ™ Scoring &amp; Revive Rules</b>
        <ul>
          <li>ç¬¬ä¸€æ¬¡ç­”å¯¹ First try correctï¼š<b>+2 åˆ† / +2 points ï¼‹ 1 ç¢ç‰‡ shard</b></li>
          <li>åŒä¸€é¢˜å†æ¬¡ç­”å¯¹ Correct on retryï¼š<b>+1 åˆ† / +1 point</b></li>
          <li>ç¬¬ä¸€æ¬¡ç­”é”™ First wrongï¼š<b>-1 åˆ† / -1 point</b>ï¼Œé¢˜ç›®ä¼šåœ¨åé¢å†å‡ºç°ä¸¤æ¬¡ Question will reappear twice later</li>
          <li>å†æ¬¡ç­”é”™ Wrong againï¼š<b>-2 åˆ† / -2 points</b></li>
          <li>æ¯è¿å¯¹ 5 é¢˜ Every 5-correct comboï¼š<b>é¢å¤– +2 ç¢ç‰‡ extra shards</b></li>
          <li>å®Œæˆç« èŠ‚ Chapter completedï¼š  
            å‡†ç¡®ç‡ Accuracy â‰¥ 90%ï¼š+8 ç¢ç‰‡ï¼›80â€“89%ï¼š+5ï¼›70â€“79%ï¼š+3</li>
          <li>50 ç¢ç‰‡ = 1 å¼ å¤æ´»å¡ã€‚50 shards = 1 revive card.</li>
          <li>æ¯ä¸ªç« èŠ‚æœ€å¤šä½¿ç”¨ 2 æ¬¡å¤æ´»å¡ã€‚Max 2 revives per chapter.</li>
          <li>ä½¿ç”¨å¤æ´»å¡æ—¶ï¼šè¿™é¢˜ç®—ä½œç­”å¯¹ï¼Œä½†<b>ä¸å†é¢å¤–é€ç¢ç‰‡æˆ–è¿å¯¹å¥–åŠ±</b>ã€‚  
              When a revive is used, this question counts as correct, but <b>no extra shards or combo bonus</b>.</li>
        </ul>
      </div>
    </section>
  </section>

  <section id="menu">
    <div id="topbar">
      <div class="nav-left">
        <button id="back-to-welcome" class="pill-btn light">â­  å›åˆ°ç®€ä»‹ / Back</button>
        <span class="chip">
          <b>å·²ç™»å½• Logged in:</b> <span id="user-display">-</span>
        </span>
      </div>
      <div class="nav-right">
        <span id="wallet-display">ç¢ç‰‡ Shards: 0 ï½œ å¤æ´» Revives: 0</span>
        <button id="convert-revive-btn" class="pill-btn light" style="display:none;">
          âœ¨ 50 ç¢ç‰‡æ¢ 1 å¤æ´» / Convert 50 shards â†’ 1 revive
        </button>
        <button id="my-results-btn" class="pill-btn light">ğŸ“Š æˆ‘çš„æˆç»© / My Results</button>
        <button id="sound-toggle" class="pill-btn" title="å¼€å…³éŸ³æ•ˆ / Toggle sound">
          ğŸ””<span>ON</span>
        </button>
        <div id="session-timer">ä¼šè¯å‰©ä½™ / Session left: <span id="session-remaining">05:00</span></div>
      </div>
    </div>

    <h2 class="section-title">é€‰æ‹©ç« èŠ‚ / Select Chapter</h2>
    <p class="section-sub">
      å»ºè®®å…ˆæŠŠåŸºç¡€ç« èŠ‚åˆ·åˆ° <b>æ­£ç¡®ç‡ 80% ä»¥ä¸Š</b>ï¼Œå†æŒ‘æˆ˜éš¾åº¦è¾ƒé«˜çš„ç« èŠ‚ã€‚<br/>
      Itâ€™s recommended to push your accuracy above 80% on core chapters before moving to the harder ones.
    </p>

    <div id="chapter-list" class="chapter-grid">
      <!-- ç« èŠ‚æŒ‰é’®ç”± JS åŠ¨æ€ç”Ÿæˆ -->
    </div>
  </section>

  <section id="quiz">
    <div id="quiz-card">
      <div id="quiz-meta">
        <div id="quiz-meta-left">
          <div id="quiz-chapter-label" class="label-pill">
            <span>ğŸ“š</span> <span id="quiz-chapter-text">Chapter</span>
          </div>
          <div id="quiz-stats">
            é¢˜ç›® Question: <span id="quiz-index">1</span> /
            <span id="quiz-total">0</span>
            Â· å·²ç­” Answered: <span id="quiz-answered">0</span>
          </div>
        </div>
        <div id="quiz-meta-right">
          <div id="score-badge">
            åˆ†æ•° Score: <span id="current-score">0</span> pts
          </div>
          <div class="text-xs" style="color:#6b7280;">
            æ­£ç¡® Correct: <span id="correct-count">0</span> Â·
            é”™è¯¯ Wrong: <span id="wrong-count">0</span>
          </div>
        </div>
      </div>

      <div class="progress-wrap">
        <div id="quiz-progress-inner" class="progress-inner"></div>
      </div>

      <h3 id="quiz-title">Title</h3>
      <div id="quiz-question">Question text</div>
      <ul id="quiz-options"></ul>

      <div id="quiz-footer">
        <div id="quiz-footer-left">
          <span class="text-xs" id="quiz-tip">å°æç¤ºï¼šè®¤çœŸè¯»é¢˜ï¼Œåˆ«æ€¥ç€æŒ‰ã€‚Read carefully before you tap.</span>
        </div>
        <div id="quiz-footer-right">
          <span class="text-xs">è¿™é¢˜å·²å°è¯• Attempts on this question: <span id="attempt-count">0</span></span>
        </div>
      </div>
    </div>
  </section>

  <section id="finish">
    <div id="finish-card">
      <h3 class="mb-4">ç« èŠ‚å®Œæˆï¼Chapter Finished!</h3>
      <div id="finish-summary"></div>
      <div class="mt-12 flex-wrap gap-10">
        <button id="retry-wrong-btn" class="pill-btn light">é‡åˆ·é”™é¢˜ / Retry wrong questions</button>
        <button id="back-to-menu" class="pill-btn primary">è¿”å›ç« èŠ‚é€‰æ‹© / Back to chapter list</button>
      </div>
    </div>
  </section>

  <section id="results">
    <div class="card">
      <div class="flex-between">
        <h3 class="mb-0">ğŸ“Š æˆ‘çš„æˆç»© / My Results</h3>
        <button id="back-to-chapters-btn" class="pill-btn light">è¿”å›ç« èŠ‚ / Back to chapters</button>
      </div>
      <table id="results-table">
        <thead>
          <tr>
            <th>æ—¥æœŸ Date</th>
            <th>ç« èŠ‚ Chapter</th>
            <th>å¾—åˆ† Score</th>
            <th>å‡†ç¡®ç‡ Accuracy</th>
            <th>ç”¨æ—¶ Time</th>
          </tr>
        </thead>
        <tbody id="results-tbody"></tbody>
      </table>
      <p class="text-xs" style="color:#6b7280;margin-top:8px;">
        * åªæ˜¾ç¤ºæœ€è¿‘ 30 æ¡è®°å½•ã€‚Only the latest 30 records are shown.
      </p>
    </div>
  </section>

  <a id="wa-fab" href="#" target="_blank" rel="noopener" title="WhatsApp çºªè€å¸ˆ / Chat with Mr Kee">
    ğŸ’¬
  </a>

  <p class="text-xs text-center" style="margin-top:24px;color:#9ca3af;">
    çºªè€å¸ˆç²¾è‹±è®­ç»ƒç½‘ Â· Kee Web Quiz Â· SPM P1 Booster
  </p>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  /* ============================
     åªæ”¹è¿™ä¸€è¡Œåˆ‡æ¢ç§‘ç›®ï¼š
     'SEJ' | 'SC' | 'ACC'
     ============================ */
  const SUBJECT_PREFIX = 'SEJ';

  /* ä¸‰ç§‘å„è‡ªçš„æˆç»©è¡¨ï¼ˆè¯»äº‘ç«¯ï¼‰ */
  const SHEET_IDS = {
    SEJ: '1EBWtRvzy3f4i0m8bbvjHVeir4isT4QmLLQSLGwPkCOM',
    ACC: '16bvfhuPSsYt8jHApfhq4bqNXUXh2BRhgPgUCPE1oToM',
    SC:  '1bUFFiucc1p_z2eFWq6AEdIvdHVZ8gIn_trDJ8PDT_s8'
  };

  /* ä¸‰ç§‘å„è‡ªçš„ Apps Scriptï¼ˆå†™å…¥äº‘ç«¯ & é’±åŒ…ï¼‰ */
  const GAS_ENDPOINTS = {
    SEJ: 'https://script.google.com/macros/s/AKfycbxcXEdzviEERt2uqLfgIXLQ3LecB-O8oph_HIiWk8RWq0XjGSd-l9v2ejUf07jq2TA/exec',
    ACC: 'https://script.google.com/macros/s/AKfycby9rb7WDeIA3qRR90eEufBFSszA6T3SyFGtfpTOpu3DgxbjlYAahKq6s6G8ZP2Hf6KYYA/exec',
    SC:  'https://script.google.com/macros/s/AKfycbzpsvBY7xqT5ELcVhiBGf8w9Q_ay9b5mZE52XwnjA1WyLR6H4t1CSDLd5GiCPEbvagE1Q/exec'
  };

  const SHEET_ID = SHEET_IDS[SUBJECT_PREFIX];
  const SCRIPT_URL = GAS_ENDPOINTS[SUBJECT_PREFIX];

  function makeResultsUrl(){
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1&nocache=${Date.now()}`;
  }

  const SUBJECT_MAP = {
    SEJ: ['SEJ','Sejarah'],
    SC:  ['SC','Science'],
    ACC: ['ACC','Accounting']
  };
  const [abbr, fullName] = SUBJECT_MAP[SUBJECT_PREFIX] || [SUBJECT_PREFIX, SUBJECT_PREFIX];
  document.getElementById('brand-icon').textContent = abbr;
  document.getElementById('brand-title').innerHTML =
    `SPM ${abbr} Paper 1 è¶…å¼ºè®­ç»ƒå™¨ / <b id="brand-boost">${abbr} P1 Booster</b>`;

  const waUrl =
    `https://wa.me/60167312519?text=`+
    encodeURIComponent(`Hi Mr Kee, I'd like to ask about ${abbr} P1 Booster.`);
  document.getElementById('wa-fab').href = waUrl;
  document.getElementById('wa-link').href = waUrl;

  /* ===== ç™»å½•/ä¼šè¯ï¼ˆè¯•ç”¨5åˆ†é’Ÿï¼‰ ===== */
  let user = '', usedUniversal = false;
  const UWP_WINDOW_MS = 5 * 60 * 1000;
  function setUniversalStart(ts){ localStorage.setItem('uwpStart', String(ts)); }
  function getUniversalStart(){ const v=localStorage.getItem('uwpStart'); return v? Number(v):0; }
  function clearUniversalStart(){ localStorage.removeItem('uwpStart'); }
  function universalRemainingMs(){
    const start=getUniversalStart();
    if(!start) return 0;
    const elapsed = Date.now()-start;
    const left = UWP_WINDOW_MS - elapsed;
    return left>0? left:0;
  }

  const sessionTimerEl = document.getElementById('session-timer');
  const sessionRemainingEl = document.getElementById('session-remaining');
  let sessionTimerId = null;

  function showSessionTimer(show){
    sessionTimerEl.style.display = show ? 'inline-flex' : 'none';
  }

  function updateSessionTimer(){
    if(!usedUniversal){
      showSessionTimer(false);
      if(sessionTimerId){ clearInterval(sessionTimerId); sessionTimerId=null; }
      return;
    }
    showSessionTimer(true);
    function tick(){
      const left = universalRemainingMs();
      if(left<=0){
        sessionRemainingEl.textContent = '00:00';
        clearInterval(sessionTimerId); sessionTimerId=null;
        alert('è¯•ç”¨æ—¶é—´å·²ç»“æŸï¼Œè¯·è”ç³»è€å¸ˆå¼€é€šå®Œæ•´è´¦å·ã€‚\nYour trial has ended. Please contact your teacher to unlock full access.');
        location.reload();
        return;
      }
      const m = Math.floor(left/60000);
      const s = Math.floor((left%60000)/1000);
      sessionRemainingEl.textContent =
        String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
    }
    if(sessionTimerId) clearInterval(sessionTimerId);
    tick();
    sessionTimerId = setInterval(tick, 1000);
  }

  function guardUniversalWindowOrThrow(){
    if(!usedUniversal) return;
    if(universalRemainingMs()<=0){
      alert('è¯•ç”¨æ—¶é—´å·²ç»“æŸï¼Œè¯·è”ç³»è€å¸ˆå¼€é€šå®Œæ•´è´¦å·ã€‚\nYour trial has ended. Please contact your teacher to unlock full access.');
      location.reload();
      throw new Error('trial ended');
    }
  }

  const userDisplay = document.getElementById('user-display');
  const backToWelcomeBtn = document.getElementById('back-to-welcome');

  function enterMenu(){
    document.getElementById('welcome').style.display='none';
    document.getElementById('menu').style.display='block';
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='none';
    document.getElementById('results').style.display='none';
  }

  backToWelcomeBtn.onclick = () => {
    document.getElementById('welcome').style.display='block';
    document.getElementById('menu').style.display='none';
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='none';
    document.getElementById('results').style.display='none';
  };

  const loginBtn = document.getElementById('loginBtn');
  const startBtn = document.getElementById('startBtn');

  loginBtn.onclick = attemptLogin;
  startBtn.onclick = attemptLogin;

  function getPasswordsUrl(){
    return 'Passwords.csv?nocache=' + Date.now();
  }

  document.getElementById('startBtn').onclick = attemptLogin;
  document.getElementById('my-results-btn').onclick = openResults;
  document.getElementById('back-to-menu').onclick = backToMenu;
  document.getElementById('back-to-chapters-btn').onclick = () => {
    document.getElementById('results').style.display='none';
    document.getElementById('menu').style.display='block';
  };

  const soundToggleBtn = document.getElementById('sound-toggle');
  let soundOn = true;

  soundToggleBtn.onclick = () => {
    soundOn = !soundOn;
    if(soundOn){
      soundToggleBtn.classList.remove('muted');
      soundToggleBtn.innerHTML = 'ğŸ””<span>ON</span>';
    }else{
      soundToggleBtn.classList.add('muted');
      soundToggleBtn.innerHTML = 'ğŸ”•<span>OFF</span>';
    }
  };

  function playSound(type){
    if(!soundOn) return;
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      if(type==='correct'){
        osc.frequency.value = 880;
      }else{
        osc.frequency.value = 220;
      }
      gain.gain.setValueAtTime(0.0001, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.3);
      osc.start();
      osc.stop(ctx.currentTime+0.35);
    }catch(e){
      console.warn('Audio error', e);
    }
  }

  function attemptLogin(){
    const nm=document.getElementById('username').value.trim();
    const pw=document.getElementById('password').value;
    if(!nm||!pw){
      alert('è¯·è¾“å…¥å§“åä¸å¯†ç  / Please enter both name and password.');
      return;
    }
    Papa.parse(getPasswordsUrl(),{
      download:true,header:true,skipEmptyLines:true,
      complete: async (res)=>{
        const rows=(res.data||[]).map(r=>{
          const o={};
          Object.entries(r).forEach(([k,v])=>{
            o[String(k).trim().toLowerCase()] =
              typeof v==='string'? v.trim(): v;
          });
          return o;
        });
        const nameKey='name', passKey='password';
        const uwpRow=rows.find(r=>r[nameKey]==='*');
        const uwpPassword=uwpRow?(uwpRow[passKey]||''):'';
        // é€šç”¨è¯•ç”¨å¯†ç  Universal trial password
        if(uwpPassword && pw===uwpPassword){
          if(universalRemainingMs()<=0) setUniversalStart(Date.now());
          usedUniversal=true; updateSessionTimer();
          user=nm;
          await afterLogin();
          return;
        }
        const match=rows.find(r=>
          String(r[nameKey]||'').toLowerCase()===nm.toLowerCase()
          && String(r[passKey]||'')===pw
        );
        if(!match){
          alert('å§“åæˆ–å¯†ç ä¸æ­£ç¡® / Name or password incorrect.');
          return;
        }
        clearUniversalStart(); usedUniversal=false; showSessionTimer(false);
        user=nm;
        await afterLogin();
      },
      error:()=> alert('æ— æ³•è¯»å– Passwords.csvï¼Œè¯·ç¡®è®¤æ–‡ä»¶å­˜åœ¨ä¸”å¯å…¬å¼€è®¿é—®ã€‚\nCannot load Passwords.csv, please check access.')
    });
  }

  async function afterLogin(){
    await fetchCloudResultsFor(user);
    loadLocalResults();
    await loadWallet();
    userDisplay.textContent=user;
    enterMenu();
  }

  /* ===== é’±åŒ… Walletï¼ˆäº‘ç«¯ + æœ¬åœ°æ˜¾ç¤ºï¼‰ ===== */
  const walletDisplay = document.getElementById('wallet-display');
  const convertBtn    = document.getElementById('convert-revive-btn');
  let wallet = { shards:0, revives:0 };

  // æœ¬æ¬¡ç™»å½•å†…çš„ã€Œç¢ç‰‡ / å¤æ´»å¡ã€å‡€å˜åŒ–ï¼ˆç»Ÿä¸€åšå¢é‡åŒæ­¥ï¼‰
  let sessionShardDelta  = 0;   // + è¡¨ç¤ºæ–°å¢ç¢ç‰‡ï¼Œ- è¡¨ç¤ºæ¶ˆè€—
  let sessionReviveDelta = 0;   // + æ–°å¢å¤æ´»å¡ï¼ˆå…‘æ¢ï¼‰ï¼Œ- ä½¿ç”¨å¤æ´»å¡
  let revivesUsedThisChapter = 0;

  const REVIVE_COST = 50;
  const MAX_REVIVES_PER_CHAPTER = 2;

  function updateWalletUI(){
    walletDisplay.textContent =
      `ç¢ç‰‡ Shards: ${wallet.shards} ï½œ å¤æ´» Revives: ${wallet.revives}`;
    convertBtn.style.display = user ? 'inline-flex' : 'none';
  }

  // è¯»å–é’±åŒ…ï¼šå¯¹æ¥ Apps Script çš„ action=wallet-get
  async function loadWallet(){
    if(!user) return;
    try{
      const url = `${SCRIPT_URL}?action=wallet-get&name=${encodeURIComponent(user)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('wallet http');
      const data = await res.json();
      wallet.shards  = Number(data.shards  || 0);
      wallet.revives = Number(data.revives || 0);
    }catch(e){
      console.error('loadWallet error', e);
      wallet = { shards:0, revives:0 };
    }
    updateWalletUI();
  }

  // æŠŠæœ¬æ¬¡ session çš„å¢é‡å†™å›äº‘ç«¯ï¼šaction=wallet-update
  async function syncWalletToServer(){
    if(!user) return;
    if(!sessionShardDelta && !sessionReviveDelta) return;
    try{
      const body = new URLSearchParams();
      body.append('action','wallet-update');
      body.append('name', user);
      if(sessionShardDelta)  body.append('shardsDelta',  String(sessionShardDelta));
      if(sessionReviveDelta) body.append('revivesDelta', String(sessionReviveDelta));
      await fetch(SCRIPT_URL,{ method:'post', body });
      sessionShardDelta  = 0;
      sessionReviveDelta = 0;
    }catch(e){
      console.error('syncWallet error', e);
    }
  }

  // å…‘æ¢å¤æ´»å¡ï¼š50 ç¢ç‰‡ â†’ 1 å¤æ´»å¡ï¼ˆå®æ—¶åŒæ­¥ï¼‰
  convertBtn.onclick = async () => {
    if(!user) return alert('è¯·å…ˆç™»å½• / Please log in first.');
    if(wallet.shards < REVIVE_COST){
      alert(`ç¢ç‰‡ä¸è¶³ï¼šéœ€è¦ ${REVIVE_COST} æ‰èƒ½å…‘æ¢ 1 å¼ å¤æ´»å¡ã€‚
Not enough shards: need ${REVIVE_COST} to convert 1 revive.`);
      return;
    }
    if(!confirm(`ç¡®å®šä½¿ç”¨ ${REVIVE_COST} ç¢ç‰‡å…‘æ¢ 1 å¼ å¤æ´»å¡å—ï¼Ÿ
Convert ${REVIVE_COST} shards into 1 revive card?`)) return;
    wallet.shards  -= REVIVE_COST;
    wallet.revives += 1;
    sessionShardDelta  -= REVIVE_COST;
    sessionReviveDelta += 1;
    updateWalletUI();
    await syncWalletToServer();
    alert('å…‘æ¢æˆåŠŸï¼å·²è·å¾— 1 å¼ å¤æ´»å¡ã€‚
Conversion successful! You gained 1 revive card.');
  };

  
  /* ===== æˆç»©å­˜å–ï¼ˆæœ¬åœ° + äº‘ç«¯ï¼‰ ===== */
  const LS_KEY = (name)=>`results_${SUBJECT_PREFIX}_${name.toLowerCase()}`;
  let cloudResults=[], localResults=[];
  function loadLocalResults(){
    try{ localResults = JSON.parse(localStorage.getItem(LS_KEY(user))||'[]'); }
    catch{ localResults=[]; }
  }
  function saveLocalResult(rec){
    loadLocalResults();
    localResults.push(rec);
    localStorage.setItem(LS_KEY(user), JSON.stringify(localResults));
  }
  function mergeResults(){ return [...cloudResults, ...localResults]; }

  function fetchCloudResultsFor(name){
    return new Promise((resolve)=>{
      Papa.parse(makeResultsUrl(),{
        download:true, header:true, skipEmptyLines:true,
        complete:(res)=>{
          const rows=(res.data||[]).map(r=>{
            const norm={};
            Object.entries(r).forEach(([k,v])=>{
              norm[String(k).trim().toLowerCase()] =
                typeof v==='string'? v.trim(): v;
            });
            const rawId = norm.quizid || '';
            const quizId = rawId.replace(/\s+/g,'');
            const score = Number(norm.score || 0);
            const accuracy = Number(norm.accuracy || 0);
            const time = norm.time || '';
            const date = norm.date || '';
            const chapterName = norm.chapter || norm['chapter name'] || '';
            return { quizId, score, accuracy, time, date, chapterName };
          }).filter(r=>r.quizId);
          cloudResults = rows;
          resolve(rows);
        },
        error:(err)=>{
          console.error('fetchCloudResults error', err);
          cloudResults=[];
          resolve([]);
        }
      });
    });
  }

  function renderChapterList(){
    const list = document.getElementById('chapter-list');
    list.innerHTML = '';
    const chapters = [
      { id:'C1', name:'Bab 1: ...', level:'åŸºç¡€ Core', tags:['å¿…ä¼š Basic','ä¸»å¹² Main topics'] },
      { id:'C2', name:'Bab 2: ...', level:'åŸºç¡€ Core', tags:['é‡ç‚¹ Focus','é«˜é¢‘ High frequency'] },
      { id:'C3', name:'Bab 3â€“4: ...', level:'è¿›é˜¶ Advance', tags:['æ•´åˆ Integrative'] },
      { id:'C4', name:'Bab 5â€“6: ...', level:'è¿›é˜¶ Advance', tags:['é«˜é˜¶ Higher order'] },
      { id:'C5', name:'Bab 7â€“8: ...', level:'å†²åˆº Sprint', tags:['è€ƒå‰å†²åˆº Final sprint'] }
    ];
    chapters.forEach(ch=>{
      const card=document.createElement('div');
      card.className='chapter-card';

      const header=document.createElement('div');
      header.className='chapter-card-header';

      const left=document.createElement('div');
      const title=document.createElement('div');
      title.className='chapter-title';
      title.textContent=ch.name;
      const meta=document.createElement('div');
      meta.className='chapter-meta';
      meta.textContent=ch.level;
      left.appendChild(title);
      left.appendChild(meta);

      const right=document.createElement('div');
      right.className='chapter-progress';
      right.innerHTML=`
        <span>å®Œæˆåº¦ Progress</span>
        <span id="progress-${ch.id}">0%</span>
      `;

      header.appendChild(left);
      header.appendChild(right);
      card.appendChild(header);

      const barWrap=document.createElement('div');
      barWrap.className='chapter-progress-bar';
      const barInner=document.createElement('div');
      barInner.className='chapter-progress-bar-inner';
      barInner.id=`progress-bar-${ch.id}`;
      barWrap.appendChild(barInner);
      card.appendChild(barWrap);

      const tagsRow=document.createElement('div');
      tagsRow.className='chapter-tags';
      ch.tags.forEach(t=>{
        const span=document.createElement('span');
        span.className='tag';
        span.textContent=t;
        tagsRow.appendChild(span);
      });
      card.appendChild(tagsRow);

      const bottom=document.createElement('div');
      bottom.className='chapter-bottom';
      const info=document.createElement('span');
      info.textContent='é¢˜é‡ Questions: ~30â€“50';
      const btn=document.createElement('button');
      btn.textContent='å¼€å§‹åˆ·é¢˜ / Start';
      btn.onclick=()=>startChapter(ch);
      bottom.appendChild(info);
      bottom.appendChild(btn);

      card.appendChild(bottom);
      list.appendChild(card);
    });
  }

  let qs=[], queue=[], score=0, correct=0, wrong=0, chapterStart=0;
  let correctStreak=0, wrongStreak=0;
  const MAX_OPTS=15;

  function getPasswordsUrlReload(){
    return 'Passwords.csv?nocache=' + Date.now();
  }

  function backToMenu(){
    document.getElementById('menu').style.display='block';
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='none';
    document.getElementById('results').style.display='none';
  }

  function startChapter(chapter){
    guardUniversalWindowOrThrow();
    revivesUsedThisChapter = 0;
    const chapterId = chapter.id;
    const chapterName = chapter.name;
    loadChapterQuestions(chapterId, chapterName);
  }

  function loadChapterQuestions(chapterId, chapterName){
    document.getElementById('menu').style.display='none';
    document.getElementById('quiz').style.display='block';
    document.getElementById('finish').style.display='none';
    document.getElementById('results').style.display='none';

    document.getElementById('quiz-chapter-text').textContent = chapterName;
    document.getElementById('quiz-title').textContent = chapterName;

    chapterStart = Date.now();
    score=0; correct=0; wrong=0;
    correctStreak=0; wrongStreak=0;

    const csvUrl = `questions_${SUBJECT_PREFIX}_${chapterId}.csv?nocache=${Date.now()}`;
    Papa.parse(csvUrl,{
      download:true, header:true, skipEmptyLines:true,
      complete:(res)=>{
        qs = (res.data||[]).map((row,i)=>{
          const opts=[];
          for(let k of ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O']){
            if(row[k] && String(row[k]).trim()){
              opts.push({ key:k, text:String(row[k]).trim() });
            }
          }
          return {
            id:i+1,
            question:String(row.question||row.Question||'').trim(),
            options:opts,
            answer:String(row.answer||row.Answer||'').trim().toUpperCase(),
            attempt:0,
            used:false
          };
        }).filter(q=>q.question && q.options.length>0 && q.answer);
        queue = [...qs];
        document.getElementById('quiz-total').textContent = queue.length;
        document.getElementById('quiz-answered').textContent = 0;
        document.getElementById('current-score').textContent = score;
        document.getElementById('correct-count').textContent = 0;
        document.getElementById('wrong-count').textContent = 0;
        document.getElementById('quiz-progress-inner').style.width = '0%';
        nextQuestion();
      },
      error:(err)=>{
        console.error('loadChapterQuestions error',err);
        alert('æ— æ³•è½½å…¥é¢˜ç›®ï¼Œè¯·ç¨åé‡è¯•ã€‚\nUnable to load questions. Please try again later.');
        backToMenu();
      }
    });
  }

  function nextQuestion(){
    if(queue.length===0){
      endChapterSummary();
      return;
    }
    const idx = Math.floor(Math.random()*queue.length);
    const q = queue[idx];
    queue.splice(idx,1);

    document.getElementById('quiz-index').textContent = qs.length - queue.length;
    document.getElementById('quiz-question').textContent = q.question;
    const ul = document.getElementById('quiz-options');
    ul.innerHTML='';
    q.options.forEach(opt=>{
      const li=document.createElement('li');
      const label=document.createElement('span');
      label.className='opt-label';
      label.textContent=opt.key;
      const text=document.createElement('span');
      text.className='opt-text';
      text.textContent=opt.text;
      li.appendChild(label);
      li.appendChild(text);
      li.onclick=()=>handleAnswer(q,opt.key,li);
      ul.appendChild(li);
    });
    document.getElementById('attempt-count').textContent = q.attempt;
  }

  function handleAnswer(q, chosenKey, li){
    guardUniversalWindowOrThrow();

    if(li.classList.contains('disabled')) return;
    const correctKey = q.answer;
    const isCorrect = chosenKey === correctKey;

    const ul = document.getElementById('quiz-options');
    [...ul.children].forEach(item=>{
      item.classList.add('disabled');
      const label = item.querySelector('.opt-label');
      if(label && label.textContent === correctKey){
        item.classList.add('correct');
      }
    });

    li.classList.add(isCorrect ? 'correct' : 'wrong');

    let isC = isCorrect;
    let usedRevive = false;
    if(!isC && wallet.revives>0 && revivesUsedThisChapter < MAX_REVIVES_PER_CHAPTER){
      const msg =
`ä½ ç­”é”™äº†ï¼Œä½†ä½ æœ‰å¤æ´»å¡ ğŸƒ
æ˜¯å¦ä½¿ç”¨ 1 å¼ å¤æ´»å¡æŠŠè¿™é¢˜ç®—ä½œç­”å¯¹ï¼Ÿ
Do you want to use 1 revive to count this question as correct?`;
      if(confirm(msg)){
        usedRevive = true;
        isC = true;                 // è§†ä¸ºç­”å¯¹
        wallet.revives -= 1;
        sessionReviveDelta -= 1;
        revivesUsedThisChapter += 1;
        updateWalletUI();
        syncWalletToServer();
      }
    }

    let delta = 0;
    let shardsEarned = 0;
    let comboBonus = 0;

    if(isC){
      delta = q.attempt ? 1 : 2;
      score += delta;
      correct++;
      correctStreak++;
      wrongStreak=0;

      if(q.attempt===0 && !usedRevive){
        shardsEarned += 1;
      }
      if(!usedRevive && correctStreak>0 && correctStreak % 5 === 0){
        comboBonus += 2;
      }
    }else{
      delta = q.attempt ? -2 : -1;
      score += delta;
      wrong++;
      wrongStreak++;
      correctStreak=0;

      if(q.attempt===0){
        queue.push({ ...q, attempt:q.attempt+1 });
        queue.push({ ...q, attempt:q.attempt+2 });
      }
    }

    const answered = correct + wrong;
    const total = qs.length;
    document.getElementById('quiz-answered').textContent = answered;
    document.getElementById('current-score').textContent = score;
    document.getElementById('correct-count').textContent = correct;
    document.getElementById('wrong-count').textContent = wrong;
    const progress = Math.round(answered/total*100);
    document.getElementById('quiz-progress-inner').style.width = `${progress}%`;

    if(shardsEarned>0 || comboBonus>0){
      const totalShardsThisClick = shardsEarned + comboBonus;
      wallet.shards += totalShardsThisClick;
      sessionShardDelta += totalShardsThisClick;
      updateWalletUI();
    }

    showScoreBubble(li, delta);

    setTimeout(nextQuestion, 500);
  }

  function showScoreBubble(li, delta){
    const bubble=document.createElement('div');
    bubble.className='score-bubble ' + (delta>=0 ? 'plus' : 'minus');
    bubble.textContent = (delta>=0?'+':'') + delta;
    li.appendChild(bubble);
    setTimeout(()=>bubble.remove(), 800);
  }

  function endChapterSummary(){
    const now = Date.now();
    const durationMs = now - chapterStart;
    const durationMin = (durationMs/60000).toFixed(1);
    const total = correct + wrong;
    const accuracy = total>0 ? Math.round(correct/total*100) : 0;

    let bonusShards = 0;
    if(accuracy>=90) bonusShards=8;
    else if(accuracy>=80) bonusShards=5;
    else if(accuracy>=70) bonusShards=3;

    if(bonusShards>0){
      wallet.shards += bonusShards;
      sessionShardDelta += bonusShards;
      updateWalletUI();
    }

    const summary=document.getElementById('finish-summary');
    summary.innerHTML = `
      <p>æœ¬ç« å®Œæˆï¼ä½ ä¸€å…±ç­”å¯¹ <b>${correct}</b> é¢˜ï¼Œç­”é”™ <b>${wrong}</b> é¢˜ã€‚</p>
      <p>å¾—åˆ† Score: <b>${score}</b> åˆ† Â· å‡†ç¡®ç‡ Accuracy: <b>${accuracy}%</b> Â· ç”¨æ—¶ Time: <b>${durationMin} åˆ†é’Ÿ</b></p>
      <p>æœ¬ç« é¢å¤–ç¢ç‰‡å¥–åŠ± Shards bonus this chapter: <b>${bonusShards}</b></p>
    `;

    const rec = {
      quizId: `CH-${Date.now()}`,
      score,
      accuracy,
      time: `${durationMin} min`,
      date: new Date().toLocaleString(),
      chapterName: document.getElementById('quiz-chapter-text').textContent
    };
    saveLocalResult(rec);
    saveResultToCloud(rec);

    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';

    const ctrl=document.getElementById('finish-card');
    const btn=document.createElement('button');
    btn.className='pill-btn';
    btn.textContent='è¿”å›ç« èŠ‚é€‰æ‹© / Back to chapter list';
    btn.onclick=backToMenu;
    ctrl.appendChild(btn);

    // æŠŠæœ¬æ¬¡ç¢ç‰‡ & å¤æ´»ä½¿ç”¨åŒæ­¥åˆ°äº‘ç«¯
    syncWalletToServer();
  }

  async function saveResultToCloud(rec){
    try{
      const body = new URLSearchParams();
      body.append('action','append');
      body.append('quizId', rec.quizId);
      body.append('name', user);
      body.append('score', String(rec.score));
      body.append('accuracy', String(rec.accuracy));
      body.append('time', rec.time);
      body.append('date', rec.date);
      body.append('chapter', rec.chapterName);
      await fetch(SCRIPT_URL,{ method:'post', body });
    }catch(e){
      console.error('saveResultToCloud error', e);
    }
  }

  function openResults(){
    guardUniversalWindowOrThrow();
    fetchCloudResultsFor(user).then(()=>{
      const all=mergeResults();
      const tbody=document.getElementById('results-tbody');
      tbody.innerHTML='';
      const latest=all.slice(-30).reverse();
      latest.forEach(rec=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${rec.date}</td>
          <td>${rec.chapterName}</td>
          <td>${rec.score}</td>
          <td>${rec.accuracy}%</td>
          <td>${rec.time}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('menu').style.display='none';
      document.getElementById('quiz').style.display='none';
      document.getElementById('finish').style.display='none';
      document.getElementById('results').style.display='block';
      document.getElementById('back-to-chapters-btn').style.display='inline-flex';
    });
  }

  renderChapterList();
});
  </script>
</body>
</html>
