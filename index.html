<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>çºªè€å¸ˆ SPM P1 è¶…å¼ºè®­ç»ƒå™¨ / SPM P1 Booster</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    :root{
      --black:#111; --fg:#111; --bg:#fff; --muted:#555;
      --green:#16a34a; --green-2:#22c55e;
      --border:#eee; --shadow:0 6px 20px rgba(0,0,0,.06);
    }
    html,body{ background:#fff; }
    body{
      font-family: Arial, sans-serif;
      max-width:1100px; margin:auto;
      text-align:center; color:var(--fg);
    }
    body::before{
      content:""; position:fixed; inset:-10% -10% auto -10%;
      height:68vh; pointer-events:none; z-index:-2;
      background:
        radial-gradient(600px 240px at 10% 0%,rgba(34,197,94,.06),rgba(255,255,255,0) 60%),
        radial-gradient(520px 220px at 90% 12%, rgba(59,130,246,.06),rgba(255,255,255,0) 60%),
        radial-gradient(420px 200px at 50% -8%, rgba(168,85,247,.05), rgba(255,255,255,0) 60%);
    }
    body::after{
      content:""; position:fixed; inset:0;
      pointer-events:none; z-index:-3;
      background-image:
        radial-gradient(rgba(0,0,0,.035) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(0,0,0,.015), rgba(0,0,0,0));
      background-size: 12px 12px, 100% 100%;
      background-position: 0 0, 0 0;
    }
    #welcome,#menu,#quiz,#finish,#results{ margin:20px; }
    #menu,#quiz,#finish,#results{ display:none; }

    #topbar{
      position:sticky; top:8px; z-index:50;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin:12px 0;
    }
    .nav-left,.nav-right{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .pill-btn{
      border:0; background:#111; color:#fff;
      padding:8px 12px; border-radius:999px;
      cursor:pointer; box-shadow:var(--shadow);
      font-size:13px;
    }
    .pill-btn.light{ background:#222; }
    .pill-btn.primary{ background:#0ea5e9; }
    .pill-btn:disabled{ opacity:.6; cursor:not-allowed; }

    #session-timer{
      background:#111; color:#fff;
      padding:6px 10px; border-radius:999px;
      font-size:11px; opacity:.9; display:none;
      box-shadow:0 4px 10px rgba(0,0,0,.25);
    }
    #sound-toggle.muted{ background:#555; }
    #my-results-btn,#back-to-chapters-btn{ display:none; }

    #wallet-display{
      font-size:12px; color:#111;
      padding:4px 10px; border-radius:999px;
      background:#f4f4f5;
    }

    .hero{
      margin:28px auto; padding:32px 28px;
      border-radius:22px; max-width:950px;
      background:
        radial-gradient(1200px 420px at -10% -10%, #e7f8ff 0%, rgba(255,255,255,0) 60%),
        radial-gradient(900px 320px at 110% 20%, #eef9f1 0%, rgba(255,255,255,0) 55%),
        linear-gradient(135deg,#fff,#fafafa);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      text-align:center;
    }
    .brand{
      display:flex; align-items:center; justify-content:center;
      gap:14px; flex-wrap:wrap;
    }
    .brand-icon{
      width:56px; height:56px; border-radius:16px;
      background:#111; color:#fff;
      display:grid; place-items:center;
      font-weight:800; letter-spacing:.5px;
      box-shadow:var(--shadow);
    }
    .brand-title{ margin:0; font-size:30px; line-height:1.15; }
    .brand-sub{ margin:6px 0 0; color:#555; font-size:14px; }
    .tag-row{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    .tag{
      font-size:12px; padding:6px 12px;
      border-radius:999px; border:1px solid #e5e7eb;
      background:#fff; color:#111;
    }
    .tag.hot{ border-color:var(--green); color:var(--green); background:#f0fff5; }

    h2{ margin-top:26px; }
    h3{ margin-top:18px; text-align:left; }

    .group{ margin:6px 0 18px; text-align:left; }
    .group h4{ margin:8px 0; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      margin:6px; padding:8px 12px;
      border-radius:999px; background:#111; color:#fff;
      border:0; cursor:pointer; font-size:14px;
    }
    .badge{
      background:#fff; color:#111;
      padding:2px 8px; border-radius:999px;
      font-size:12px;
    }
    .badge-gray{ background:#e5e7eb; color:#111; }
    .badge-green{ background:#22c55e; color:#fff; }

    .question{
      text-align:left; margin:15px 0; padding:16px 20px;
      border:2px solid #ddd; border-radius:14px;
      transition:transform .18s, box-shadow .18s, border-color .18s;
      position:relative;
      background:#fff;
    }
    .option-label{ display:block; margin:6px 0; cursor:pointer; }
    .feedback{ font-weight:bold; margin:10px 0; min-height:1.2em; }

    img{ max-width:100%; margin:10px 0; border:2px solid #ccc; border-radius:10px; }

    .correct-glow{
      border-color:#23c55e!important;
      box-shadow:0 0 0 4px rgba(34,197,94,.15);
      transform:scale(1.01);
    }
    .wrong-shake{
      border-color:#ef4444!important;
      animation:shake .28s ease-in-out 0s 1, flashRed .9s ease 0s 1;
    }
    @keyframes shake{
      10%,90%{transform:translateX(-1px);}
      20%,80%{transform:translateX(2px);}
      30%,50%,70%{transform:translateX(-3px);}
      40%,60%{transform:translateX(3px);}
    }
    @keyframes flashRed{
      0%{box-shadow:0 0 0 0 rgba(239,68,68,.35);}
      100%{box-shadow:0 0 0 10px rgba(239,68,68,0);}
    }

    .score-bubble{
      position:absolute; right:10px; top:-6px;
      font-weight:700; padding:2px 8px;
      border-radius:999px; font-size:12px;
      animation:popUp 900ms ease forwards;
      pointer-events:none;
    }
    .score-bubble.plus{
      background:rgba(34,197,94,.15); color:#16a34a;
    }
    .score-bubble.minus{
      background:rgba(239,68,68,.15); color:#dc2626;
    }
    @keyframes popUp{
      0%{transform:translateY(0);opacity:0;}
      15%{opacity:1;}
      100%{transform:translateY(-24px);opacity:0;}
    }

    .progress-wrap{
      width:100%; margin-top:6px;
      border-radius:12px; padding:6px;
      transition: box-shadow .25s;
    }
    .progress-wrap.flash-green{
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }
    .progress-wrap.flash-red{
      box-shadow:0 0 0 4px rgba(239,68,68,.25);
    }
    progress{ width:100%; height:20px; }
    progress::-webkit-progress-bar{ background-color:#eee; border-radius:10px; }
    progress::-webkit-progress-value{ background-color:#111; border-radius:10px; }
    progress::-moz-progress-bar{ background:#111; border-radius:10px; }

    #streak{ margin-top:6px; font-size:13px; color:#555; min-height:1.2em; }
    .streak-good{ color:#16a34a; }
    .streak-bad{ color:#dc2626; }

    table{ border-collapse:collapse; width:100%; }
    th,td{ border:1px solid #e5e7eb; padding:8px; text-align:left; font-size:13px; }
    th{ background:#f3f4f6; }
    .muted{ color:#666; font-size:12px; }

    #confetti{
      position:fixed; inset:0; pointer-events:none;
      overflow:hidden; z-index:9998;
    }
    .confetti-piece{
      position:absolute; width:10px; height:16px;
      opacity:.9; border-radius:3px;
      animation:fall linear forwards;
    }
    @keyframes fall{
      0%{transform:translateY(-120%) rotate(0deg);}
      100%{transform:translateY(120vh) rotate(720deg);}
    }

    .wa-fab{
      position:fixed; right:18px; bottom:18px; z-index:60;
      background:#25D366; color:#fff;
      padding:12px 16px; border-radius:999px;
      box-shadow:var(--shadow); text-decoration:none;
      font-weight:700; font-size:14px;
    }
    .wa-fab:hover{ filter:brightness(1.05); }

    footer{ margin:40px auto 24px; color:#444; font-size:14px; }
    footer a{ color:#0ea5e9; text-decoration:none; }
    footer a:hover{ text-decoration:underline; }

    .rules-box{
      margin-top:10px; padding:10px 14px;
      border-radius:12px; background:#f9fafb;
      text-align:left; font-size:12px; color:#444;
    }
    .rules-box ul{ padding-left:18px; margin:4px 0; }
    .rules-box li{ margin:2px 0; }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="nav-left">
      <button id="back-to-chapters-btn" class="pill-btn primary">ğŸ  å›åˆ°ç« èŠ‚é€‰æ‹© / Back to Chapters</button>
      <div id="session-timer">ä¼šè¯å‰©ä½™ / Session left: <span id="session-remaining">05:00</span></div>
    </div>
    <div class="nav-right">
      <span id="wallet-display">ç¢ç‰‡ Shards: 0 ï½œ å¤æ´» Revives: 0</span>
      <button id="convert-revive-btn" class="pill-btn light" style="display:none;">
        âœ¨ 50 ç¢ç‰‡æ¢ 1 å¤æ´» / Convert 50 shards â†’ 1 revive
      </button>
      <button id="my-results-btn" class="pill-btn light">ğŸ“Š æˆ‘çš„æˆç»© / My Results</button>
      <button id="sound-toggle" class="pill-btn" title="å¼€å…³éŸ³æ•ˆ / Toggle sound">ğŸ”Š éŸ³æ•ˆå·²å¼€ / Sound ON</button>
    </div>
  </div>
  <div id="confetti"></div>

  <section class="hero">
    <div class="brand">
      <div class="brand-icon" id="brand-icon">SUB</div>
      <div>
        <h1 class="brand-title" id="brand-title">
          SPM P1 è¶…å¼ºè®­ç»ƒå™¨ / <b id="brand-boost">P1 Booster</b>
        </h1>
        <p class="brand-sub">
          æŒ‰ç« èŠ‚ç²¾ç»ƒ Ã— å·å±è¯•å·å®æˆ˜ Ã— é”™é¢˜äºŒæ¬¡å›åˆ· Ã— æˆç»©è‡ªåŠ¨ä¸Šä¼   
          Chapter drilling Ã— State papers Ã— Wrong questions repeat twice Ã— Auto result upload
        </p>
        <div class="tag-row">
          <span class="tag hot">Form 4 / Form 5</span>
          <span class="tag hot">Chapter &amp; State Papers</span>
          <span class="tag hot">Repeat wrong twice</span>
          <span class="tag hot">Leaderboard Ready</span>
          <span class="tag hot">Revive &amp; Shards System</span>
        </div>
      </div>
    </div>
    <div class="rules-box">
      <b>ğŸ® è®¡åˆ† &amp; å¤æ´»è§„åˆ™ Scoring &amp; Revive Rules</b>
      <ul>
        <li>ç¬¬ä¸€æ¬¡ç­”å¯¹ First try correctï¼š<b>+2 åˆ† +1 ç¢ç‰‡ shard</b></li>
        <li>åŒä¸€é¢˜å†æ¬¡ç­”å¯¹ Correct on retryï¼š<b>+1 åˆ†</b></li>
        <li>ç¬¬ä¸€æ¬¡ç­”é”™ First wrongï¼š<b>-1 åˆ†</b>ï¼Œé¢˜ç›®ä¼šåœ¨åé¢å†å‡ºç°ä¸¤æ¬¡ Question will reappear twice later</li>
        <li>å†æ¬¡ç­”é”™ Wrong againï¼š<b>-2 åˆ†</b></li>
        <li>æ¯è¿å¯¹ 5 é¢˜ Every 5-correct comboï¼š<b>é¢å¤– +2 ç¢ç‰‡ extra shards</b></li>
        <li>å®Œæˆç« èŠ‚ Chapter completedï¼š  
          å‡†ç¡®ç‡ Accuracy â‰¥ 90%ï¼š+8 ç¢ç‰‡ï¼›80â€“89%ï¼š+5ï¼›70â€“79%ï¼š+3</li>
        <li>50 ç¢ç‰‡ = 1 å¼ å¤æ´»å¡ã€‚50 shards = 1 revive card.</li>
        <li>æ¯ä¸ªç« èŠ‚æœ€å¤šä½¿ç”¨ 2 æ¬¡å¤æ´»å¡ã€‚Max 2 revives per chapter.</li>
        <li>ä½¿ç”¨å¤æ´»å¡æ—¶ This question will be counted as correct, but no extra shards or combo bonus.</li>
      </ul>
    </div>
  </section>

  <div id="welcome">
    <h2>è¯·è¾“å…¥å§“åä¸å¯†ç  / Enter Your Name &amp; Password</h2>
    <input type="text" id="username" placeholder="å§“å / Name"/>
    <input type="password" id="password" placeholder="å¯†ç  / Password"/>
    <button id="startBtn" type="button" class="pill-btn">ç™»å½• / Log In</button>
    <div class="muted" style="margin-top:8px;">
      å…è´¹è¯•ç”¨å¯†ç ï¼š<b>testing</b>ï¼ˆ5 åˆ†é’Ÿ 5 minutesï¼‰ï¼›
      RM10 ä¸€æ¬¡æ€§å¼€é€š Unlock unlimited practice once.  
      è´­ä¹°è¯·è”ç³»ï¼šçºªè€å¸ˆ 016-7312519ã€‚
    </div>
  </div>

  <div id="menu"><h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2></div>

  <div id="quiz">
    <h3 id="quiz-title"></h3>
    <div id="score">å¾—åˆ† Score: 0</div>
    <div id="remaining">å‰©ä½™é¢˜ç›® Remaining: 0</div>
    <div id="streak"></div>
    <div id="progressWrap" class="progress-wrap">
      <progress id="progress" value="0" max="0"></progress>
    </div>
    <div id="question-area" style="position:relative;"></div>
  </div>

  <div id="finish">
    <h3 id="finish-msg"></h3>
    <p id="stats"></p>
    <div id="controls"></div>
  </div>

  <div id="results">
    <h2>ğŸ“Š æˆ‘çš„æˆç»© / My Results</h2>
    <div id="results-summary" class="muted"></div>
    <div id="results-table-wrap"></div>
    <div style="margin-top:12px;">
      <button class="pill-btn light" id="back-to-menu">
        è¿”å›ç« èŠ‚åˆ—è¡¨ / Back to chapter list
      </button>
    </div>
  </div>

  <!-- æˆç»©æäº¤ï¼ˆè¡¨å• action ä¼šæŒ‰ç§‘ç›®è‡ªåŠ¨è®¾ç½®ï¼‰ -->
  <iframe name="postFrame" style="display:none;"></iframe>
  <form id="postForm" method="post" target="postFrame" style="display:none;">
    <input name="quizId"/><input name="name"/><input name="score"/>
    <input name="correct"/><input name="wrong"/><input name="time"/>
  </form>

  <a class="wa-fab" id="wa-fab" href="https://wa.me/60167312519" target="_blank" rel="noopener">
    ğŸ’¬ WhatsApp
  </a>
  <footer>
    å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·è”ç³»çºªè€å¸ˆ 016-7312519ï¼Œæˆ–ç›´æ¥
    <a id="wa-link" href="https://wa.me/60167312519" target="_blank" rel="noopener">
      ä¸€é”®æ‰“å¼€ WhatsApp / Open WhatsApp
    </a>ã€‚
  </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ============================
     åªæ”¹è¿™ä¸€è¡Œåˆ‡æ¢ç§‘ç›®ï¼š
     'SEJ' | 'SC' | 'ACC'
     ============================ */
  const SUBJECT_PREFIX = 'SEJ';

  /* ä¸‰ç§‘å„è‡ªçš„æˆç»©è¡¨ï¼ˆè¯»äº‘ç«¯ï¼‰ */
  const SHEET_IDS = {
    SEJ: '1EBWtRvzy3f4i0m8bbvjHVeir4isT4QmLLQSLGwPkCOM',
    ACC: '16bvfhuPSsYt8jHApfhq4bqNXUXh2BRhgPgUCPE1oToM',
    SC:  '1bUFFiucc1p_z2eFWq6AEdIvdHVZ8gIn_trDJ8PDT_s8'
  };

  /* ä¸‰ç§‘å„è‡ªçš„ Apps Scriptï¼ˆå†™å…¥äº‘ç«¯ & é’±åŒ…ï¼‰ */
  const GAS_ENDPOINTS = {
    SEJ: 'https://script.google.com/macros/s/AKfycbxcXEdzviEERt2uqLfgIXLQ3LecB-O8oph_HIiWk8RWq0XjGSd-l9v2ejUf07jq2TA/exec',
    ACC: 'https://script.google.com/macros/s/AKfycbxMi-Xv5OWubnwx-tDS2XPsKhUpfGf1e-rMtgPFs4mwA4VvEL1L7gVEXiN_oFK9hyaLWQ/exec',
    SC:  'https://script.google.com/macros/s/AKfycbx9A1jZ8oqSKExIfVCKnNiFmvPy407QqZBnZTRalU0IL4DSuOp9Nb4izaynd_4C54j3/exec'
  };

  const SHEET_ID = SHEET_IDS[SUBJECT_PREFIX];
  const SCRIPT_URL = GAS_ENDPOINTS[SUBJECT_PREFIX];

  /* è¯»å–æˆç»©ç”¨ CSV åœ°å€ï¼ˆå¸¦é˜²ç¼“å­˜ï¼‰ */
  function makeResultsUrl(){
    return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1&nocache=${Date.now()}`;
  }

  /* æäº¤æˆç»©ç”¨çš„è¡¨å• action */
  const postForm = document.getElementById('postForm');
  postForm.action = SCRIPT_URL;

  /* åŠ¨æ€å“ç‰Œæ–‡æ¡ˆ Brand text */
  const SUBJECT_MAP = {
    SEJ: ['SEJ','Sejarah'],
    SC : ['SC','Science'],
    ACC: ['ACC','Accounting']
  };
  const [abbr, fullName] = SUBJECT_MAP[SUBJECT_PREFIX] || [SUBJECT_PREFIX, SUBJECT_PREFIX];
  document.getElementById('brand-icon').textContent = abbr;
  document.getElementById('brand-title').innerHTML =
    `SPM ${abbr} Paper 1 è¶…å¼ºè®­ç»ƒå™¨ / <b id="brand-boost">${abbr} P1 Booster</b>`;

  const waUrl =
    `https://wa.me/60167312519?text=`+
    encodeURIComponent(`Hi Mr Kee, I'd like to ask about ${abbr} P1 Booster.`);
  document.getElementById('wa-fab').href = waUrl;
  document.getElementById('wa-link').href = waUrl;

  /* ===== ç™»å½•/ä¼šè¯ï¼ˆè¯•ç”¨5åˆ†é’Ÿï¼‰ ===== */
  let user = '', usedUniversal = false;
  const UWP_WINDOW_MS = 5 * 60 * 1000;
  function setUniversalStart(ts){ localStorage.setItem('uwpStart', String(ts)); }
  function getUniversalStart(){ const v=localStorage.getItem('uwpStart'); return v? Number(v):0; }
  function clearUniversalStart(){ localStorage.removeItem('uwpStart'); }
  function universalRemainingMs(){
    const s=getUniversalStart(); if(!s) return 0;
    const r=UWP_WINDOW_MS-(Date.now()-s); return r>0?r:0;
  }
  function showSessionTimer(b){
    document.getElementById('session-timer').style.display = b?'block':'none';
  }
  function updateSessionTimer(){
    if(!usedUniversal){ showSessionTimer(false); return; }
    const rem=universalRemainingMs();
    if(rem<=0){
      showSessionTimer(false);
      alert('ä¼šè¯å·²åˆ°æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚\nSession expired, please log in again.');
      location.reload();
      return;
    }
    const mm=Math.floor(rem/60000);
    const ss=Math.floor((rem%60000)/1000).toString().padStart(2,'0');
    document.getElementById('session-remaining').textContent=`${mm}:${ss}`;
    showSessionTimer(true);
  }
  setInterval(updateSessionTimer, 500);

  /* ===== éŸ³æ•ˆ ===== */
  let audioOn = true, audioCtx;
  const sndBtn = document.getElementById('sound-toggle');
  sndBtn.onclick = () => {
    audioOn = !audioOn;
    sndBtn.classList.toggle('muted', !audioOn);
    sndBtn.textContent = audioOn ? 'ğŸ”Š éŸ³æ•ˆå·²å¼€ / Sound ON' : 'ğŸ”ˆ éŸ³æ•ˆå·²å…³ / Sound OFF';
  };
  function ensureCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
  function beep(freq=880, dur=0.14, type='sine', gain=0.06){
    if(!audioOn) return;
    ensureCtx();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g).connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+dur);
    o.stop(audioCtx.currentTime+dur+0.02);
  }
  function playRight(){ beep(1100,.10,'sine',.06); setTimeout(()=>beep(1500,.12,'sine',.05),90); }
  function playWrong(){ beep(220,.12,'sawtooth',.05); setTimeout(()=>beep(160,.14,'square',.05),100); }

  /* ===== é’±åŒ… Walletï¼ˆäº‘ç«¯ + æœ¬åœ°æ˜¾ç¤ºï¼‰ ===== */
  const walletDisplay = document.getElementById('wallet-display');
  const convertBtn = document.getElementById('convert-revive-btn');
  let wallet = { shards:0, revives:0 };
  let sessionShardDelta = 0;        // æœ¬æ¬¡ç™»å½•å†…ç¢ç‰‡å˜åŒ–
  let sessionRevivesUsed = 0;       // æœ¬ç« èŠ‚å®é™…æ¶ˆè€—å¤æ´»å¼ æ•°ï¼ˆç”¨äºé™åˆ¶ + å›å†™ï¼‰
  let revivesUsedThisChapter = 0;
  const REVIVE_COST = 50;
  const MAX_REVIVES_PER_CHAPTER = 2;

  function updateWalletUI(){
    walletDisplay.textContent =
      `ç¢ç‰‡ Shards: ${wallet.shards} ï½œ å¤æ´» Revives: ${wallet.revives}`;
    convertBtn.style.display = user ? 'inline-flex' : 'none';
  }

  async function loadWallet(){
    if(!user) return;
    try{
      const url = `${SCRIPT_URL}?mode=wallet&name=${encodeURIComponent(user)}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('wallet http');
      const data = await res.json();
      wallet.shards = Number(data.shards || 0);
      wallet.revives = Number(data.revives || 0);
    }catch(e){
      console.error('loadWallet error', e);
      wallet = { shards:0, revives:0 };
    }
    updateWalletUI();
  }

  async function syncWalletToServer(){
    if(!user) return;
    if(!sessionShardDelta && !sessionRevivesUsed) return;
    try{
      const body = new URLSearchParams();
      body.append('mode','wallet-update');
      body.append('name', user);
      body.append('deltaShards', String(sessionShardDelta));
      body.append('revivesUsed', String(sessionRevivesUsed)); // åç«¯è‡ªå·±å‡å°‘
      await fetch(SCRIPT_URL,{ method:'post', body });
      sessionShardDelta = 0;
      sessionRevivesUsed = 0;
    }catch(e){
      console.error('syncWallet error', e);
    }
  }

  convertBtn.onclick = () => {
    if(!user) return alert('è¯·å…ˆç™»å½• / Please log in first.');
    if(wallet.shards < REVIVE_COST){
      alert(`ç¢ç‰‡ä¸è¶³ï¼šéœ€è¦ ${REVIVE_COST} æ‰èƒ½å…‘æ¢ 1 å¼ å¤æ´»å¡ã€‚\nNot enough shards: need ${REVIVE_COST} to convert 1 revive.`);
      return;
    }
    if(!confirm(`ç¡®å®šä½¿ç”¨ ${REVIVE_COST} ç¢ç‰‡å…‘æ¢ 1 å¼ å¤æ´»å¡å—ï¼Ÿ\nConvert ${REVIVE_COST} shards into 1 revive card?`)) return;
    wallet.shards -= REVIVE_COST;
    wallet.revives += 1;
    sessionShardDelta -= REVIVE_COST; // å› ä¸ºæ¶ˆè€—äº†
    updateWalletUI();
    alert('å…‘æ¢æˆåŠŸï¼å·²è·å¾— 1 å¼ å¤æ´»å¡ã€‚\nConversion successful! You gained 1 revive card.');
  };

  /* ===== æˆç»©å­˜å–ï¼ˆæœ¬åœ° + äº‘ç«¯ï¼‰ ===== */
  const LS_KEY = (name)=>`results_${SUBJECT_PREFIX}_${name.toLowerCase()}`;
  let cloudResults=[], localResults=[];
  function loadLocalResults(){
    try{ localResults = JSON.parse(localStorage.getItem(LS_KEY(user))||'[]'); }
    catch{ localResults=[]; }
  }
  function saveLocalResult(rec){
    loadLocalResults();
    localResults.push(rec);
    localStorage.setItem(LS_KEY(user), JSON.stringify(localResults));
  }
  function mergeResults(){ return [...cloudResults, ...localResults]; }

  function fetchCloudResultsFor(name){
    return new Promise((resolve)=>{
      Papa.parse(makeResultsUrl(),{
        download:true, header:true, skipEmptyLines:true,
        complete:(res)=>{
          const rows=(res.data||[]).map(r=>{
            const norm={};
            Object.entries(r).forEach(([k,v])=>{
              norm[String(k).trim().toLowerCase()] =
                typeof v==='string'? v.trim(): v;
            });
            const rawId = norm.quizid || norm.quiz_id || '';
            if(!new RegExp(`^${SUBJECT_PREFIX}\\|`, 'i').test(rawId)) return null;
            return {
              quizId   : rawId,
              quizIdPure: String(rawId).replace(/^.*?\|/, '').trim(),
              name     : norm.name || '',
              score    : Number(norm.score||0),
              correct  : Number(norm.correct||0),
              wrong    : Number(norm.wrong||0),
              time     : Number(norm.time||0),
              timestamp: norm.timestamp || ''
            };
          }).filter(r=> r && String(r.name||'').toLowerCase()===name.toLowerCase());
          cloudResults = rows;
          resolve(rows);
        },
        error:()=>{ cloudResults=[]; resolve([]); }
      });
    });
  }

  function buildBestPercentMap(){
    const all=mergeResults(), best={};
    all.forEach(r=>{
      const pure = (r.quizIdPure || String(r.quizId||'').replace(/^.*?\|/, '')).trim();
      const c = Number(r.correct||0), w = Number(r.wrong||0), tot=c+w;
      if(!pure || tot<=0) return;
      const pct = Math.round((c/tot)*100);
      if(!(pure in best) || pct>best[pure]) best[pure]=pct;
    });
    return best;
  }
  function bestPercentForChapter(chap, bestMap){
    let candidate = (bestMap[chap] != null) ? bestMap[chap] : null;
    for(const [k,v] of Object.entries(bestMap)){
      if(k.startsWith(chap + '_')) candidate = Math.max(candidate ?? -Infinity, v);
    }
    return candidate;
  }

  /* ===== é¢˜åº“/èœå• & æµ‹éªŒçŠ¶æ€ ===== */
  let chapters=[], grouped={};
  let chapterKey, sectionKey, labelKey, sheetKey;
  let currentChapter='';
  let qs=[], queue=[], score=0, correct=0, wrong=0, chapterStart=0;
  let correctStreak=0, wrongStreak=0;
  const MAX_OPTS=15;

  const PASSWORDS_CSV = 'Passwords.csv';

  document.getElementById('startBtn').onclick = attemptLogin;
  document.getElementById('my-results-btn').onclick = openResults;
  document.getElementById('back-to-menu').onclick = backToMenu;
  document.getElementById('back-to-chapters-btn').onclick = backToMenu;

  function backToMenu(){
    document.getElementById('results').style.display='none';
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='none';
    document.getElementById('menu').style.display='block';
    document.getElementById('menu').scrollIntoView({behavior:'smooth'});
  }

  function attemptLogin(){
    const nm=document.getElementById('username').value.trim();
    const pw=document.getElementById('password').value;
    if(!nm||!pw){
      alert('è¯·è¾“å…¥å§“åä¸å¯†ç  / Please enter both name and password.');
      return;
    }
    Papa.parse(PASSWORDS_CSV,{
      download:true,header:true,skipEmptyLines:true,
      complete: async (res)=>{
        const rows=(res.data||[]).map(r=>{
          const o={};
          Object.entries(r).forEach(([k,v])=>{
            o[String(k).trim().toLowerCase()] =
              typeof v==='string'? v.trim(): v;
          });
          return o;
        });
        const nameKey='name', passKey='password';
        const uwpRow=rows.find(r=>r[nameKey]==='*');
        const uwpPassword=uwpRow?(uwpRow[passKey]||''):'';
        // é€šç”¨è¯•ç”¨å¯†ç  Universal trial password
        if(uwpPassword && pw===uwpPassword){
          if(universalRemainingMs()<=0) setUniversalStart(Date.now());
          usedUniversal=true; updateSessionTimer();
          user=nm;
          await afterLogin();
          return;
        }
        const match=rows.find(r=>
          String(r[nameKey]||'').toLowerCase()===nm.toLowerCase()
          && String(r[passKey]||'')===pw
        );
        if(!match){
          alert('å§“åæˆ–å¯†ç ä¸æ­£ç¡® / Name or password incorrect.');
          return;
        }
        clearUniversalStart(); usedUniversal=false; showSessionTimer(false);
        user=nm;
        await afterLogin();
      },
      error:()=> alert('æ— æ³•è¯»å– Passwords.csvï¼Œè¯·ç¡®è®¤æ–‡ä»¶å­˜åœ¨ä¸”å¯å…¬å¼€è®¿é—®ã€‚\nCannot load Passwords.csv, please check access.')
    });
  }

  async function afterLogin(){
    await fetchCloudResultsFor(user);
    loadLocalResults();
    await loadWallet();
    document.getElementById('my-results-btn').style.display='inline-block';
    document.getElementById('back-to-chapters-btn').style.display='inline-block';
    document.getElementById('welcome').style.display='none';
    loadChapters();
    setTimeout(()=>document.getElementById('menu').scrollIntoView({behavior:'smooth'}),50);
  }

  function guardUniversalWindowOrThrow(){
    if(!usedUniversal) return;
    if(universalRemainingMs()<=0){
      alert('ä¼šè¯å·²åˆ°æœŸï¼Œè¯·é‡æ–°ç™»å½•ã€‚\nSession expired, please log in again.');
      location.reload();
      throw new Error('Session expired');
    }
  }

  function loadChapters(){
    Papa.parse('Chapters.csv',{
      download:true,header:true,skipEmptyLines:true,
      complete(res){
        guardUniversalWindowOrThrow();
        chapters=(res.data||[]).map(raw=>{
          const r={};
          Object.entries(raw).forEach(([k,v])=>{
            r[String(k).trim()] = typeof v==='string'? v.trim(): v;
          });
          return r;
        });
        if(!chapters.length){
          alert('è¯·æ£€æŸ¥ Chapters.csv æ˜¯å¦å­˜åœ¨å†…å®¹ã€‚\nPlease check Chapters.csv.');
          return;
        }
        const keys=Object.keys(chapters[0]);
        chapterKey=keys.find(k=>k.toLowerCase()==='chapter');
        sectionKey=keys.find(k=>k.toLowerCase()==='section');
        labelKey  =keys.find(k=>k.toLowerCase()==='label');
        sheetKey  =keys.find(k=>k.toLowerCase()==='sheet');

        grouped={};
        chapters.forEach(r=>{
          const c=r[chapterKey];
          (grouped[c]||(grouped[c]=[])).push(r);
        });
        renderMenu();
      }
    });
  }

  function renderMenu(){
    const menu=document.getElementById('menu');
    menu.innerHTML='<h2>è¯·é€‰æ‹©ç« èŠ‚ / Select Chapter</h2>';

    const statePapers={2025:{},2024:{},2023:{}}; 
    const chaptersF4={2025:[],2024:[],2023:[]};
    const chaptersF5={2025:[],2024:[],2023:[]};

    Object.keys(grouped).forEach(chap=>{
      const year = chap.match(/2025/)?2025 :
                   chap.match(/2024/)?2024 :
                   chap.match(/2023/)?2023 : null;
      if(!year) return;
      if(/(Chp|Bab)/i.test(chap)){
        if(/F4/i.test(chap)) chaptersF4[year].push(chap);
        else if(/F5/i.test(chap)) chaptersF5[year].push(chap);
      } else {
        const state = chap.split(' ')[0];
        (statePapers[year][state] ||= []).push(chap);
      }
    });

    const bestPctMap = buildBestPercentMap();

    const makeChapterButton=(chap)=>{
      const btn=document.createElement('button');
      btn.className='pill';
      btn.textContent=chap;
      const badge=document.createElement('span');
      const best=bestPercentForChapter(chap,bestPctMap);
      if(best!=null){
        badge.className='badge badge-green';
        badge.textContent=`æœ€é«˜å‡†ç¡®ç‡ Best: ${best}%`;
      }else{
        badge.className='badge badge-gray';
        badge.textContent='æœªåš / Not attempted';
      }
      btn.appendChild(badge);
      btn.onclick=()=>{ guardUniversalWindowOrThrow(); startChapter(chap); };
      return btn;
    };

    [2025,2024,2023].forEach(y=>{
      const states=statePapers[y];
      if(Object.keys(states).length){
        const h=document.createElement('h2');
        h.textContent=`å·å±è¯•å· State Papers ${y}`;
        menu.appendChild(h);
        for(const st of Object.keys(states).sort()){
          const g=document.createElement('div'); g.className='group';
          const h4=document.createElement('h4');
          h4.textContent=`${st}`; g.appendChild(h4);
          states[st].sort().forEach(ch=> g.appendChild(makeChapterButton(ch)));
          menu.appendChild(g);
        }
      }
    });

    [2025,2024,2023].forEach(y=>{
      if(chaptersF4[y].length){
        const h=document.createElement('h2');
        h.textContent=`Form 4 Chapters ${y}`;
        menu.appendChild(h);
        const g=document.createElement('div'); g.className='group';
        chaptersF4[y].sort((a,b)=>{
          const na=parseInt(a.match(/(Chp|Bab)\s*(\d+)/i)?.[2]||0);
          const nb=parseInt(b.match(/(Chp|Bab)\s*(\d+)/i)?.[2]||0);
          return (na-nb)||a.localeCompare(b);
        }).forEach(ch=> g.appendChild(makeChapterButton(ch)));
        menu.appendChild(g);
      }
    });

    [2025,2024,2023].forEach(y=>{
      if(chaptersF5[y].length){
        const h=document.createElement('h2');
        h.textContent=`Form 5 Chapters ${y}`;
        menu.appendChild(h);
        const g=document.createElement('div'); g.className='group';
        chaptersF5[y].sort((a,b)=>{
          const na=parseInt(a.match(/(Chp|Bab)\s*(\d+)/i)?.[2]||0);
          const nb=parseInt(b.match(/(Chp|Bab)\s*(\d+)/i)?.[2]||0);
          return (na-nb)||a.localeCompare(b);
        }).forEach(ch=> g.appendChild(makeChapterButton(ch)));
        menu.appendChild(g);
      }
    });

    menu.style.display='block';
  }

  function startChapter(chap){
    currentChapter=chap;
    score=0; correct=0; wrong=0;
    correctStreak=0; wrongStreak=0;
    revivesUsedThisChapter=0;
    updateStreak();
    chapterStart=Date.now();
    document.getElementById('menu').style.display='none';
    document.getElementById('quiz-title').textContent = chap;
    loadChapterAllSectionsAndStart();
  }

  function getBaseDir(url){
    try{
      const u=new URL(url, window.location.href);
      const s=u.toString();
      const i=s.lastIndexOf('/');
      return i>=0? s.slice(0,i+1): s;
    }catch{
      const i=url.lastIndexOf('/');
      return i>=0? url.slice(0,i+1): '';
    }
  }

  function loadChapterAllSectionsAndStart(){
    const secList=grouped[currentChapter]||[];
    if(!secList.length){
      alert('è¯¥ç« èŠ‚æ²¡æœ‰é…ç½® CSVã€‚\nNo CSV configured for this chapter.');
      renderMenu(); return;
    }
    const tasks=secList.map(sec=>new Promise((resolve)=>{
      const sheetUrl=sec[sheetKey]; const baseDir=getBaseDir(sheetUrl);
      Papa.parse(sheetUrl,{
        download:true,header:true,skipEmptyLines:true,
        complete(r){
          const rows=(r.data||[]).map(q=>({...q, attempt:0, __baseDir:baseDir }));
          resolve(rows);
        },
        error(){ resolve([]); }
      });
    }));
    Promise.all(tasks).then(list=>{
      qs=list.flat();
      if(!qs.length){
        alert('æ— æ³•è¯»å–é¢˜åº“ CSVï¼Œè¯·æ£€æŸ¥é“¾æ¥ä¸è®¿é—®æƒé™ã€‚\nCannot load question CSV.');
        renderMenu(); return;
      }
      queue=shuffle([...qs]);
      document.getElementById('quiz').style.display='block';
      document.getElementById('finish').style.display='none';
      updateUI(0);
      nextQ();
    });
  }

  function updateUI(delta){
    document.getElementById('score').textContent=
      `å¾—åˆ† Score: ${score} ${delta?`(${delta>0?'+':''}${delta})`:''}`;
    document.getElementById('remaining').textContent=
      `å‰©ä½™é¢˜ç›® Remaining: ${queue.length}`;
    const pg=document.getElementById('progress');
    pg.max=qs.length;
    pg.value=qs.length - queue.length;
  }
  function flashProgress(ok){
    const w=document.getElementById('progressWrap');
    w.classList.remove('flash-green','flash-red');
    void w.offsetWidth;
    w.classList.add(ok?'flash-green':'flash-red');
    setTimeout(()=>w.classList.remove('flash-green','flash-red'),600);
  }
  function updateStreak(){
    const el=document.getElementById('streak');
    if(correctStreak>0)
      el.innerHTML=`ğŸ”¥ è¿å¯¹ Streak: <span class="streak-good">${correctStreak}</span>`;
    else if(wrongStreak>0)
      el.innerHTML=`ğŸ˜… è¿é”™ Wrong streak: <span class="streak-bad">${wrongStreak}</span>`;
    else el.textContent='';
  }

  function nextQ(){
    guardUniversalWindowOrThrow();
    const qa=document.getElementById('question-area');
    qa.innerHTML='';
    updateUI(0);
    if(queue.length===0){ finishChapter(); return; }

    const q=queue.shift();
    const div=document.createElement('div');
    div.className='question';

    const safeQ=(q.question||'').toString().replace(/\r?\n/g,'<br/>');
    div.innerHTML=`<p><strong>${safeQ}</strong></p>`;

    if(q.image){
      let src=(q.image||'').toString().trim();
      if(!/^https?:\/\//i.test(src) && !/^data:/i.test(src))
        src=(q.__baseDir||'')+src.replace(/^\.\//,'');
      const img=document.createElement('img');
      img.src=src; img.alt='question image';
      div.appendChild(img);
    }

    const qType=(q.type||'').toString().toLowerCase();
    const opts=document.createElement('div');
    opts.className='options';

    if(qType==='text'){
      opts.innerHTML='<input type="text" id="txtAns" placeholder="è¯·è¾“å…¥ç­”æ¡ˆâ€¦ / Type your answer..."/>';
    }else{
      const letters=Array.from({length:MAX_OPTS},(_,i)=>String.fromCharCode(65+i));
      const avail=letters.filter(l=>q[l]);
      avail.forEach(l=>{
        const inp=document.createElement('input');
        inp.type=(qType==='checkbox')?'checkbox':'radio';
        inp.name='opt'; inp.value=l; inp.id='opt_'+l;
        const lbl=document.createElement('label');
        lbl.className='option-label'; lbl.htmlFor='opt_'+l;
        lbl.appendChild(inp);
        let raw=q[l];
        if(typeof raw==='string' && /^-?\d+\.0$/.test(raw)) raw=String(parseInt(raw));
        lbl.append(' '+raw);
        opts.appendChild(lbl);
      });
    }
    div.appendChild(opts);

    const fb=document.createElement('div');
    fb.className='feedback';
    div.appendChild(fb);

    const sb=document.createElement('button');
    sb.className='pill-btn';
    sb.textContent='æäº¤ / Submit';
    sb.onclick=()=>{
      guardUniversalWindowOrThrow();
      let ua=[];
      if(qType==='text'){
        ua=document.getElementById('txtAns').value.split(',')
          .map(s=>s.trim()).filter(s=>s);
      }else{
        ua=Array.from(div.querySelectorAll('input[name="opt"]:checked'))
          .map(i=>i.value);
      }
      if(!ua.length){
        alert('è¯·é€‰æ‹©æˆ–è¾“å…¥ç­”æ¡ˆ / Please select or type an answer.');
        return;
      }

      let isC=false;
      const ansStr=(q.answer||'').toString();
      if(qType==='text'){
        const lows=ua.map(s=>s.toLowerCase());
        const ansList=ansStr.split(',').map(s=>s.trim().toLowerCase());
        isC=lows.some(v=>ansList.includes(v));
      }else{
        const uaA=ua.map(s=>s.toUpperCase()).sort().join(',');
        const caA=ansStr.split(',').map(s=>s.trim().toUpperCase()).sort().join(',');
        isC = (uaA===caA);
      }

      // ==== å¤æ´»å¡é€»è¾‘ Revive logic ====
      let usedRevive = false;
      if(!isC && wallet.revives>0 && revivesUsedThisChapter < MAX_REVIVES_PER_CHAPTER){
        const msg =
`ä½ ç­”é”™äº†ï¼Œä½†ä½ æœ‰å¤æ´»å¡ ğŸƒ
æ˜¯å¦ä½¿ç”¨ 1 å¼ å¤æ´»å¡æŠŠè¿™é¢˜ç®—ä½œç­”å¯¹ï¼Ÿ
Do you want to use 1 revive to count this question as correct?`;
        if(confirm(msg)){
          usedRevive = true;
          isC = true;                 // è§†ä¸ºç­”å¯¹
          wallet.revives -= 1;
          sessionRevivesUsed += 1;
          revivesUsedThisChapter += 1;
          updateWalletUI();
        }
      }

      // ===== è®¡åˆ† & ç¢ç‰‡ =====
      let delta=0;
      let shardsEarned = 0;
      let comboBonus = 0;

      if(isC){
        // åˆ†æ•°
        delta = q.attempt ? 1 : 2;
        score += delta;
        // æ­£ç¡®/è¿å¯¹
        correct++;
        correctStreak++;
        wrongStreak=0;

        // ç¢ç‰‡ï¼šåªæœ‰ç¬¬ä¸€æ¬¡çœŸæ­£ç­”å¯¹æ‰ç»™ï¼Œå¤æ´»ä¸é€
        if(q.attempt===0 && !usedRevive){
          shardsEarned += 1;
        }
        // æ¯5è¿å¯¹é€ +2 ç¢ç‰‡ï¼ˆåŒä¸€ç« èŠ‚å¯å¤šæ¬¡è§¦å‘ï¼‰
        if(!usedRevive && correctStreak>0 && correctStreak % 5 === 0){
          comboBonus += 2;
        }
      }else{
        // ç­”é”™ä¸”æ²¡æœ‰ç”¨å¤æ´»å¡
        delta = q.attempt ? -2 : -1;
        score += delta;
        wrong++;
        wrongStreak++;
        correctStreak=0;
      }

      const shardThisAnswer = shardsEarned + comboBonus;
      if(shardThisAnswer>0){
        wallet.shards += shardThisAnswer;
        sessionShardDelta += shardThisAnswer;
        updateWalletUI();
      }

      updateStreak();

      let ansTxt='';
      if(!isC && !usedRevive){
        ansTxt=ansStr.split(',').map(letter=>q[letter]||letter).join(' / ');
      }

      if(isC && usedRevive){
        fb.textContent = 'âœ… å¤æ´»æˆåŠŸï¼è¿™é¢˜ç®—ä½œç­”å¯¹ï¼ˆä¸åŠ ç¢ç‰‡ï¼‰ã€‚Revive used, counted as correct (no shards).';
      }else if(isC){
        fb.textContent = `æ­£ç¡®! Correct! åˆ†æ•° +${delta}ï¼Œç¢ç‰‡ +${shardThisAnswer}`;
      }else{
        fb.textContent = `é”™è¯¯! Wrong! åˆ†æ•° ${delta}ï¼Œæ­£ç¡®ç­”æ¡ˆ Correct answer: ${ansTxt}`;
      }

      updateUI(delta);
      flashProgress(isC);
      sb.disabled=true;

      const bubble=document.createElement('div');
      bubble.className='score-bubble '+(delta>0?'plus':'minus');
      bubble.textContent=(delta>0?'+':'')+String(delta);
      div.appendChild(bubble);

      if(isC){ playRight(); div.classList.add('correct-glow'); setTimeout(()=>div.classList.remove('correct-glow'),900); }
      else{ playWrong(); div.classList.add('wrong-shake'); setTimeout(()=>div.classList.remove('wrong-shake'),900); }
      setTimeout(()=>bubble.remove(),1000);

      const nb=document.createElement('button');
      nb.className='pill-btn light';
      nb.style.marginLeft='8px';
      nb.textContent='ä¸‹ä¸€é¢˜ / Next';
      nb.onclick=nextQ;
      div.appendChild(nb);

      // é”™é¢˜é‡åˆ·ï¼šåªæœ‰çœŸæ­£é”™è€Œä¸”æ²¡ç”¨å¤æ´»å¡æ‰æ’å›å»
      if(!isC && !usedRevive){
        q.attempt++;
        insertWrongTwiceLater(q, queue);
      }
    };

    div.appendChild(sb);
    document.getElementById('question-area').appendChild(div);
  }

  function finishChapter(){
    document.getElementById('quiz').style.display='none';
    document.getElementById('finish').style.display='block';

    const total = correct + wrong;
    const percent = total>0 ? Math.round((correct/total)*100) : 0;

    // ç« èŠ‚å®Œæˆç¢ç‰‡å¥–åŠ± Completion shards
    let completionShards = 0;
    if(percent >= 90) completionShards = 8;
    else if(percent >= 80) completionShards = 5;
    else if(percent >= 70) completionShards = 3;
    if(completionShards>0){
      wallet.shards += completionShards;
      sessionShardDelta += completionShards;
      updateWalletUI();
    }

    document.getElementById('finish-msg').textContent=
      `æ­å–œ ${user}ï¼Œä½ å­¦ä¼šè¿™ä¸ªç« èŠ‚äº†ï¼ / Well done, ${user}!`;
    document.getElementById('stats').innerHTML =
      `å‡†ç¡®ç‡ Accuracyï¼š<b>${percent}%</b>ã€€|ã€€`+
      `åˆ†æ•° Scoreï¼š${score}ã€€|ã€€`+
      `æ­£ç¡® Correctï¼š${correct}ã€€|ã€€é”™è¯¯ Wrongï¼š${wrong}ã€€|ã€€`+
      `ç”¨æ—¶ Timeï¼š${Math.floor((Date.now()-chapterStart)/1000)} ç§’ seconds<br>`+
      (completionShards>0
        ? `ç« èŠ‚å¥–åŠ±ï¼š+${completionShards} ç¢ç‰‡ shards for completion.`
        : `æœ¬æ¬¡ç« èŠ‚æ²¡æœ‰é¢å¤–ç¢ç‰‡å¥–åŠ± No extra shards for completion this time.`);

    const form=document.getElementById('postForm');
    form.quizId.value  = `${SUBJECT_PREFIX}|${currentChapter}`;
    form.name.value    = user;
    form.score.value   = score;
    form.correct.value = correct;
    form.wrong.value   = wrong;
    form.time.value    = Math.floor((Date.now()-chapterStart)/1000);
    form.submit();

    saveLocalResult({
      quizId: form.quizId.value,
      quizIdPure: currentChapter,
      name:user,
      score, correct, wrong,
      time: form.time.value,
      timestamp: new Date().toISOString()
    });

    launchConfetti(120,1000);

    const ctrl=document.getElementById('controls');
    ctrl.innerHTML='';
    const btn=document.createElement('button');
    btn.className='pill-btn';
    btn.textContent='è¿”å›ç« èŠ‚é€‰æ‹© / Back to chapter list';
    btn.onclick=backToMenu;
    ctrl.appendChild(btn);

    // æŠŠæœ¬æ¬¡ç¢ç‰‡ & å¤æ´»ä½¿ç”¨åŒæ­¥åˆ°äº‘ç«¯
    syncWalletToServer();
  }

  function openResults(){
    guardUniversalWindowOrThrow();
    fetchCloudResultsFor(user).then(()=>{
      const all=mergeResults();
      const wrap=document.getElementById('results-table-wrap');
      wrap.innerHTML='';
      if(!all.length){
        wrap.innerHTML='<p class="muted">æš‚æ—¶æ²¡æœ‰è®°å½•ã€‚No records yet.</p>';
      }else{
        all.sort((a,b)=>{
          const ta=new Date(a.timestamp||0).getTime()||0;
          const tb=new Date(b.timestamp||0).getTime()||0;
          if(tb!==ta) return tb-ta;
          return String(a.quizId).localeCompare(String(b.quizId));
        });
        const table=document.createElement('table');
        table.innerHTML=
          `<thead>
            <tr>
              <th>æµ‹éªŒ Quiz</th>
              <th>å‡†ç¡®ç‡ Accuracy (%)</th>
              <th>åˆ†æ•° Score</th>
              <th>æ­£ç¡®/é”™è¯¯ Correct/Wrong</th>
              <th>ç”¨æ—¶(ç§’) Time(s)</th>
              <th>æ—¶é—´ Timestamp</th>
            </tr>
          </thead><tbody></tbody>`;
        const tbody=table.querySelector('tbody');
        all.forEach(r=>{
          const tot=Number(r.correct||0)+Number(r.wrong||0);
          const pct= tot>0 ? Math.round((Number(r.correct||0)/tot)*100) : 0;
          const tr=document.createElement('tr');
          tr.innerHTML =
            `<td>${escapeHtml(r.quizIdPure || String(r.quizId||'').replace(/^.*?\|/, ''))}</td>
             <td>${pct}</td>
             <td>${escapeHtml(r.score||'')}</td>
             <td>${escapeHtml(r.correct||'')}/${escapeHtml(r.wrong||'')}</td>
             <td>${escapeHtml(r.time||'')}</td>
             <td>${escapeHtml(r.timestamp||'')}</td>`;
          tbody.appendChild(tr);
        });
        wrap.appendChild(table);
      }
      document.getElementById('results-summary').textContent=
        `å½“å‰ç”¨æˆ· Current userï¼š${user}ï¼ˆäº‘ç«¯ Cloud ${cloudResults.length} æ¡ï¼Œæœ¬åœ° Local ${localResults.length} æ¡ï¼‰`;
      document.getElementById('menu').style.display='none';
      document.getElementById('results').style.display='block';
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function insertWrongTwiceLater(q, queue){
    const len=queue.length;
    let start=Math.min(1,len);
    let end1=len;
    let idx1=(len<=start)?start:(start+Math.floor(Math.random()*(end1-start+1)));
    queue.splice(idx1,0,{...q});
    const len2=queue.length;
    const start2=Math.min(1,len2);
    const end2=len2;
    let idx2=(len2<=start2)?start2:(start2+Math.floor(Math.random()*(end2-start2+1)));
    if(Math.abs(idx2-idx1)<=1 && len2>=4) idx2=Math.min(idx2+2,len2);
    queue.splice(idx2,0,{...q});
  }
  function launchConfetti(count=100,duration=1000){
    const c=document.getElementById('confetti');
    const colors=['#22c55e','#3b82f6','#f59e0b','#ef4444','#a855f7','#14b8a6'];
    for(let i=0;i<count;i++){
      const piece=document.createElement('div');
      piece.className='confetti-piece';
      piece.style.left=Math.random()*100+'vw';
      piece.style.background=colors[i%colors.length];
      piece.style.animationDuration=(0.8+Math.random()*0.8)+'s';
      piece.style.transform=`translateY(-120%) rotate(${Math.random()*360}deg)`;
      piece.style.width=(8+Math.random()*6)+'px';
      piece.style.height=(12+Math.random()*10)+'px';
      c.appendChild(piece);
      setTimeout(()=>piece.remove(),2000);
    }
    setTimeout(()=>{ c.innerHTML=''; }, duration+1200);
  }
});
</script>
</body>
</html>
